<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Sistema de Pagos Andreli</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Control Pagos">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#667eea">
<meta name="format-detection" content="telephone=no">
<style>*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background-color:#f5f5f5;color:#333;min-height:100vh;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain;-webkit-user-select:none;user-select:none;scroll-behavior:smooth}input,textarea{-webkit-user-select:text!important;user-select:text!important;-webkit-touch-callout:default!important}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding-top:calc(20px + env(safe-area-inset-top));position:sticky;top:0;z-index:100}.header h1{font-size:24px;font-weight:600}.container{padding:20px;max-width:600px;margin:0 auto;padding-bottom:calc(20px + env(safe-area-inset-bottom))}.stats-card{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.payment-method{display:inline-block;padding:3px 8px;border-radius:6px;font-size:12px;font-weight:500;margin-left:8px}.method-efectivo{background:#e8f5e9;color:#2e7d32}.method-yape{background:#e3f2fd;color:#1565c0}.method-mixto{background:#fff3cd;color:#856404}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:10px}.stat-item{text-align:center}.stat-value{font-size:28px;font-weight:bold;color:#667eea}.stat-label{font-size:14px;color:#666;margin-top:5px}.section-title{font-size:18px;font-weight:600;margin-bottom:15px;color:#333}.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:15px 30px;border-radius:10px;font-size:16px;font-weight:600;width:100%;cursor:pointer;transition:transform 0.2s;margin-bottom:15px;-webkit-appearance:none;appearance:none;touch-action:manipulation}.btn-primary:active{transform:scale(0.98);opacity:0.9}.btn-secondary{background:#f0f0f0;color:#333;border:none;padding:12px 20px;border-radius:8px;font-size:14px;cursor:pointer;transition:background 0.2s;-webkit-appearance:none;appearance:none}.btn-secondary:active{background:#e0e0e0}.client-list{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.client-item{padding:20px 15px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background 0.2s;display:flex;justify-content:space-between;align-items:center;min-height:60px;-webkit-tap-highlight-color:rgba(0,0,0,0.1)}.client-item:active{background:#f9f9f9}.client-item:last-child{border-bottom:none}.client-item.in-debt{background:#fff5f5;border-left:4px solid #dc3545}.client-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}.client-info{flex:1;min-width:0}.client-name{font-weight:600;color:#333;font-size:16px;line-height:1.3;margin-bottom:5px;word-wrap:break-word}.client-payment-info{font-size:13px;color:#666;display:flex;align-items:center;flex-wrap:wrap;gap:8px}.client-status{font-size:12px;padding:4px 10px;border-radius:12px;font-weight:500;white-space:nowrap}.status-paid{background:#d4edda;color:#155724}.status-pending{background:#fff3cd;color:#856404}.status-overdue{background:#f8d7da;color:#721c24}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0);z-index:1000;transition:background-color 0.25s ease-out}.modal.show{background:rgba(0,0,0,0.5)}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.modal-content{background:white;padding:20px;width:calc(100% - 40px);max-width:500px;border-radius:15px;max-height:calc(100vh - 40px);overflow-y:auto;-webkit-overflow-scrolling:touch;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);animation:slideIn 0.3s}@keyframes slideIn{from{transform:translate(-50%,-50%) translateY(-50px);opacity:0}to{transform:translate(-50%,-50%) translateY(0);opacity:1}}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-title{font-size:20px;font-weight:600}.close-btn{font-size:24px;cursor:pointer;color:#999;background:none;border:none;-webkit-appearance:none;appearance:none}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-weight:500;color:#333}.form-input{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;transition:border 0.2s;-webkit-appearance:none;appearance:none;background-color:white;touch-action:manipulation;-webkit-user-select:text!important;user-select:text!important}.form-input:focus{outline:none;border-color:#667eea;font-size:16px}input[type="date"]{min-height:44px;padding:12px}.payment-history{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.payments-container{height:720px;overflow-y:auto;-webkit-overflow-scrolling:touch}.payment-item{padding:12px;border-bottom:1px solid #f0f0f0}.payment-item:last-child{border-bottom:none}.payment-client{font-weight:500;color:#333}.payment-details{display:flex;justify-content:space-between;margin-top:5px;font-size:14px;color:#666}.payment-amount{color:#28a745;font-weight:600}.empty-state{text-align:center;padding:40px;color:#999}.search-container{margin-bottom:15px}.search-input{margin-bottom:0;background:#f8f9fa;border:1px solid #e0e0e0;-webkit-user-select:text!important;user-select:text!important;-webkit-touch-callout:default!important}.search-input:focus{background:white;border-color:#667eea}.client-item.hidden{display:none}.client-dropdown{position:absolute;background:white;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:1001;width:100%;box-shadow:0 4px 10px rgba(0,0,0,0.1)}.dropdown-item{padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background 0.2s}.dropdown-item:hover{background:#f8f9fa}.dropdown-item:last-child{border-bottom:none}.dropdown-item-name{font-weight:500;color:#333}.dropdown-item-phone{font-size:12px;color:#666;margin-top:2px}.form-group{margin-bottom:20px;position:relative}.clients-container{height:456px;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}.no-results{text-align:center;padding:20px;color:#999;font-style:italic}.date-filter{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.btn-danger{background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;margin-left:10px;-webkit-appearance:none;appearance:none}.btn-danger:active{background:#c82333}.frequency-badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:500;margin-left:5px}.freq-diario{background:#e8f5e9;color:#2e7d32}.freq-semanal{background:#e3f2fd;color:#1565c0}.freq-quincenal{background:#fce4ec;color:#c2185b}.freq-mensual{background:#f3e5f5;color:#7b1fa2}.whatsapp-btn{background:#25D366;color:white;border:none;padding:8px 12px;border-radius:50%;font-size:16px;cursor:pointer;margin-left:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;transition:background 0.2s,transform 0.2s;-webkit-appearance:none;appearance:none}.whatsapp-btn:active{background:#128C7E;transform:scale(0.95)}.call-btn{background:#007AFF;color:white;border:none;padding:8px 12px;border-radius:50%;font-size:16px;cursor:pointer;margin-left:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;transition:background 0.2s,transform 0.2s;-webkit-appearance:none;appearance:none}.call-btn:active{background:#0056CC;transform:scale(0.95)}.client-actions{display:flex;align-items:center;gap:8px;flex-shrink:0}.client-actions button{min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}.client-quota{background:#f0f4ff;color:#1a5490;padding:2px 8px;border-radius:6px;font-size:13px;font-weight:600;margin-left:8px}.payment-id{font-size:14px;color:#666;margin-bottom:3px;font-weight:600}.general-search-container{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.search-results{margin-top:15px;max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch}.search-result-item{padding:15px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background 0.2s}.search-result-item:hover{background:#f9f9f9}.search-result-item:last-child{border-bottom:none}.client-detail-info{margin-top:15px;padding:15px;background:#f9f9f9;border-radius:8px}.detail-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px}.detail-label{font-weight:500;color:#666}.detail-value{color:#333;font-weight:600}.action-buttons{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}.btn-action{flex:1;padding:10px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;-webkit-appearance:none;appearance:none;min-width:80px}.btn-call{background:#007AFF;color:white}.btn-whatsapp{background:#25D366;color:white}
.btn-call{background:#007AFF;color:white}
.btn-close-detail{background:#f0f0f0;color:#333}.btn-schedule{background:#6c757d;color:white}.btn-edit-client{background:#FFA500;color:white}.btn-delete-client{background:#FF3B30;color:white}.btn-movements{background:#9b59b6;color:white}.schedule-table{margin-top:20px;width:100%;border-collapse:collapse}.schedule-table th,.schedule-table td{padding:10px;border:1px solid #e0e0e0;text-align:left}.schedule-table th{background:#f8f9fa;font-weight:600;color:#333}.schedule-table tr:nth-child(even){background:#f8f9fa}.schedule-table .paid{background:#d4edda}.schedule-table .pending{background:#fff3cd}.schedule-table .future{background:white}.schedule-table .partial{background:#ffeaa7}#scheduleModal .modal-content{max-width:800px}.movements-list{margin-top:15px;max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch}.movement-item{padding:15px;border-bottom:1px solid #f0f0f0;background:white;border-radius:8px;margin-bottom:10px}.movement-item:last-child{border-bottom:none;margin-bottom:0}.movement-date{font-weight:600;color:#333;font-size:16px;margin-bottom:5px}.movement-details{display:flex;justify-content:space-between;align-items:center;margin-top:8px}.movement-method{font-size:14px;color:#666}.movement-amount{font-size:18px;font-weight:bold;color:#28a745}.check-icon{color:#28a745;font-size:20px}.partial-icon{color:#f39c12;font-size:16px}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(102,126,234,0.7)}70%{box-shadow:0 0 0 20px rgba(102,126,234,0)}100%{box-shadow:0 0 0 0 rgba(102,126,234,0)}}.btn-primary,.btn-secondary,.btn-circle{transition:all 0.2s cubic-bezier(0.4,0,0.2,1);position:relative}.btn-primary:active,.btn-secondary:active,.btn-circle:active{transform:scale(0.95)}.btn-primary:hover,.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.3)}.btn-circle:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.2)}.client-item{transition:all 0.3s ease}.client-item:hover{transform:translateX(5px);box-shadow:-5px 0 20px rgba(0,0,0,0.1)}.btn-circle{width:40px;height:40px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:all 0.2s;-webkit-appearance:none;appearance:none;flex-shrink:0}.btn-circle:active{transform:scale(0.95)}.btn-edit{background:#007AFF;color:white}.btn-pay{background:#34C759;color:white}.btn-delete{background:#FF3B30;color:white}@supports (-webkit-overflow-scrolling:touch){.payments-container,.clients-container,.search-results,.modal-content{-webkit-overflow-scrolling:touch}input[type="text"],input[type="number"],input[type="tel"],input[type="date"],select,textarea{font-size:16px!important;-webkit-appearance:none;-webkit-border-radius:0}.schedule-table{-webkit-transform:translateZ(0);transform:translateZ(0)}}@media only screen and (device-width:390px) and (device-height:844px) and (-webkit-device-pixel-ratio:3){.container{padding:15px}.client-item{padding:18px 12px}.btn-primary,.btn-secondary{font-size:15px;padding:14px 24px}}.payment-type-selector{display:flex;gap:10px;margin-bottom:20px}.payment-type-btn{flex:1;padding:15px;border:2px solid #e0e0e0;background:#f8f9fa;border-radius:10px;cursor:pointer;text-align:center;transition:all 0.2s;-webkit-appearance:none;appearance:none}.payment-type-btn:hover{background:#f0f0f0}.payment-type-btn.active{background:#667eea;color:white;border-color:#667eea}.payment-type-btn .icon{font-size:24px;margin-bottom:5px}.payment-type-btn .label{font-size:14px;font-weight:500}.payment-inputs{transition:all 0.3s ease}.debt-badge{background:#dc3545;color:white;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;margin-left:8px}.btn-morosidad{background:#dc3545;color:white;border:none;padding:15px 30px;border-radius:10px;font-size:16px;font-weight:600;width:100%;cursor:pointer;transition:transform 0.2s;margin-bottom:15px;-webkit-appearance:none;appearance:none}.btn-morosidad:active{transform:scale(0.98);opacity:0.9}.debt-clients-container{background:#fff5f5;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(220,53,69,0.1);border:1px solid #f8d7da}.debt-clients-container .client-item{margin-bottom:10px;}.debt-indicator{display:inline-block;width:8px;height:8px;background:#dc3545;border-radius:50%;margin-right:5px;animation:pulse 2s infinite}#morosidadModal .modal-content{max-width:1000px;}.morosidad-table{width:100%;border-collapse:collapse;margin-top:20px}.morosidad-table th,.morosidad-table td{padding:12px;border:1px solid #e0e0e0;text-align:left}.morosidad-table th{background:#dc3545;color:white;font-weight:600}.morosidad-table tr:nth-child(even){background:#f8f9fa}.morosidad-table tr:hover{background:#fff5f5}.morosidad-stats{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}.morosidad-stat{background:#f8f9fa;padding:15px;border-radius:8px;text-align:center}.morosidad-stat-value{font-size:24px;font-weight:bold;color:#dc3545}.morosidad-stat-label{font-size:14px;color:#666;margin-top:5px}
.morosidad-table .btn-circle{width:36px;height:36px;padding:0;margin:0 2px;}
.button-row{display:flex;gap:10px;margin-bottom:15px}.button-row .btn-primary{flex:1;margin-bottom:0}
/* Nuevos estilos para la sincronizaci√≥n */
.btn-sync{background:#17a2b8;color:white;border:none;padding:12px 20px;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.2s;-webkit-appearance:none;appearance:none;display:flex;align-items:center;gap:5px}.btn-sync:active{background:#138496;transform:scale(0.95)}.sync-status{margin-top:10px;padding:10px;border-radius:8px;font-size:14px;font-weight:500;text-align:center;display:none}.sync-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.sync-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.sync-loading{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}.sync-buttons{display:flex;gap:10px;align-items:center}.loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid #ffffff;border-radius:50%;border-top-color:transparent;animation:spin 1s ease-in-out infinite}@keyframes spin{to{transform:rotate(360deg)}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="header"><h1>Sistema de Pagos Andreli</h1></div>
<div class="container">
<div class="date-filter"><div><label for="dateFilter" class="form-label">Fecha:</label><input type="date" id="dateFilter" class="form-input" style="width:auto;"></div><div class="sync-buttons"><button class="btn-secondary" onclick="setToday()">Hoy</button><button class="btn-secondary" onclick="document.getElementById('excelUpload').click()">üìä Excel</button><button class="btn-sync" onclick="syncFromDrive()" id="syncBtn"><span id="syncIcon">üîÑ</span><span id="syncText">Sincronizar</span></button><input type="file" id="excelUpload" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelUpload(event)"></div></div>

<div id="syncStatus" class="sync-status"></div>

<div class="stats-card"><h2 class="section-title">Resumen del D√≠a</h2><div class="stats-grid"><div class="stat-item"><div class="stat-value" id="totalPaid">S/0.00</div><div class="stat-label">Total Recibido</div></div><div class="stat-item"><div class="stat-value" id="clientsPaid">0</div><div class="stat-label">Socios que Pagaron</div></div><div class="stat-item"><div class="stat-value" id="totalCash">S/0.00</div><div class="stat-label">üíµ Efectivo</div></div><div class="stat-item"><div class="stat-value" id="totalYape">S/0.00</div><div class="stat-label">üì± Yape</div></div></div></div>
<div class="general-search-container"><h2 class="section-title">Buscar Socio</h2><div class="search-container"><input type="text" class="form-input search-input" id="generalClientSearch" placeholder="üîç Buscar por nombre, ID o tel√©fono..." onkeyup="searchAllClients()"></div><div id="searchResults" class="search-results" style="display:none;"></div></div>
<div class="button-row">
<button class="btn-primary" onclick="showAddClientModal()">‚ûï Agregar Socio</button>
<button class="btn-primary" onclick="showAddPaymentModal()">üí∞ Registrar Pago</button>
</div>
<div class="button-row">
<button class="btn-morosidad" onclick="showMorosidadModal()">‚ö†Ô∏è Ver Morosidad</button>
<button class="btn-morosidad" style="background:#dc3545;" onclick="deleteAllClients()">üóëÔ∏è Eliminar Todos los Socios</button>
</div>
<div class="client-list debt-clients-container" id="debtClientsSection" style="display:none;"><h2 class="section-title"><span class="debt-indicator"></span>Socios en Mora</h2><div class="clients-container" id="debtClientsContainer"><div id="debtClientsList"><div class="empty-state">No hay socios en mora</div></div></div></div>
<div class="client-list"><h2 class="section-title">Socios del D√≠a</h2><div class="clients-container" id="clientsContainer"><div id="clientsList"><div class="empty-state">No hay socios registrados</div></div></div></div>
<div class="payment-history"><h2 class="section-title">Pagos del D√≠a</h2><div class="payments-container" id="paymentsContainer"><div id="paymentsList"><div class="empty-state">No hay pagos registrados</div></div></div></div>
</div>

<!-- Todos los modales existentes -->
<div id="addClientModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Agregar Socio</h3><button class="close-btn" onclick="closeModal('addClientModal')">&times;</button></div><form onsubmit="addClient(event)"><div class="form-group"><label class="form-label">ID del Socio</label><input type="text" class="form-input" id="clientId" required></div><div class="form-group"><label class="form-label">Nombre del Socio</label><input type="text" class="form-input" id="clientName" required></div><div class="form-group"><label class="form-label">Tel√©fono (opcional)</label><input type="tel" class="form-input" id="clientPhone"></div><div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="clientDisbursementDate" required></div><div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="clientFrequency" required><option value="">Seleccionar frecuencia...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div><div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="clientQuota" step="0.01" required></div><div class="form-group"><label class="form-label">Plazo (n√∫mero de cuotas)</label><input type="number" class="form-input" id="clientTerm" min="1" required></div><button type="submit" class="btn-primary">Agregar Socio</button></form></div></div>

<div id="addPaymentModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Registrar Pago</h3><button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button></div><form onsubmit="addPayment(event)"><div class="form-group"><label class="form-label">Socio</label><input type="text" class="form-input" id="clientSearchModal" placeholder="üîç Buscar y seleccionar socio..." autocomplete="off" onkeyup="filterModalClients()" onfocus="showClientDropdown()" required><input type="hidden" id="selectedClientId" required><div id="clientDropdown" class="client-dropdown" style="display:none;"></div></div><div class="form-group"><label class="form-label">Tipo de Pago</label><div class="payment-type-selector"><div class="payment-type-btn" onclick="selectPaymentType('efectivo')"><div class="icon">üíµ</div><div class="label">Efectivo</div></div><div class="payment-type-btn" onclick="selectPaymentType('yape')"><div class="icon">üì±</div><div class="label">Yape</div></div><div class="payment-type-btn" onclick="selectPaymentType('parcial')"><div class="icon">üí∞</div><div class="label">Pago Parcial</div></div></div></div><div id="paymentInputsContainer" style="display:none;"><div class="payment-inputs" id="singlePaymentInputs" style="display:none;"><div class="form-group"><label class="form-label" id="singlePaymentLabel">Monto</label><input type="number" class="form-input" id="paymentAmountSingle" step="0.01" min="0"></div></div><div class="payment-inputs" id="partialPaymentInputs" style="display:none;"><div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;"><div class="form-group" style="margin-bottom:15px;"><label class="form-label">üíµ Monto en Efectivo</label><input type="number" class="form-input" id="paymentAmountCash" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div><div class="form-group" style="margin-bottom:15px;"><label class="form-label">üì± Monto en Yape</label><input type="number" class="form-input" id="paymentAmountYape" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div><div style="border-top:2px solid #dee2e6;padding-top:10px;margin-top:10px;"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;font-size:16px;">Total:</span><span id="paymentTotal" style="font-size:20px;font-weight:bold;color:#667eea;">S/0.00</span></div></div></div></div></div><div class="form-group"><label class="form-label">Nota (opcional)</label><input type="text" class="form-input" id="paymentNote"></div><button type="submit" class="btn-primary">Registrar Pago</button></form></div></div>

<script>
let clients=[];
let payments=[];
let scrollPosition=0;
let selectedPaymentType='';

// Configuraci√≥n de Service Account
const SERVICE_ACCOUNT_CREDENTIALS = {
  "type": "service_account",
  "project_id": "civic-beaker-244713",
  "private_key_id": "692afba2283810998a8fc687fee612c1e8a7f06e",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDJs5bdIsHEwEF1\nVgESkNzYRPE4H/y21CZ/s/7rFg8FzxobeI57aayck6CdVCg7Gh8cJmjG89QBcMw0\ni0kXk2oL/TpoYUmrLmui2a6auS7QIOyoeI6dc6rqD+N4tLRQQH54zMj7r4bxvuPH\nq5CEL5eFTZmj8IPCC7OAuhr/hIESzJQ3hGN2+bOin9Yg3aaIP9/nHUFlkrDEDe9u\nL56gz/Ux/Y6BnXwp4T2xRaxDJLDFBAGCxlnyMytxsbBzazQ8nefWDPaOChw1egPi\nAPFV7sZbyIytVgi8Cz2aD+Ins/JZpQzJBgf36s/RkJvh0ec0Jfo/98xDyr0MfxBO\nGxkxbCKtAgMBAAECggEALM+ZVMfEBNIxuL/CvT0x01p9vNpear/3TafPmqrr6353\nbmL6RLDViHPD2zA3P+otvzNJU+oXz7ofpAzN0E8P4FoB/+6dT0qg3y09fWJm5BZs\nfYFLLe/kqNuezdJXvPyXHH9ip4f3kv213UZgdP2dzB/RYnqsyw+OcarnFJ17j5E+\nk4w7MjCq0wOxp6TvDW7Z+MqIIjFJXClK3+TKnEVOgdg6kNIzXF6DLiz6TqkTwGqH\nd3JX21+oFfZxG4swO//v4nuNGBZSUJMslxpRsmvf52JKGFpnYeF5CO8IdDFVvNCR\n0qz0uIalj4vONKX4qMYA4dd/Av40Aavjp9wfpKDQgQKBgQD19lllEbP7TXERVs0q\naE5ssSDusfXr56OoAX/7+62tbkhY7Ed6TZPICjYMGJ9+BOxN460ftSdxv7z1wbMP\nSjkAu8u+YfzZj6T0i1Gf9ko1Pr0yiCJ+XQwDRxhv+gE/HpwgDLZvQIAfK1JT2hHr\na5THGXRNJL3sV2FQGWFJimX5/wKBgQDR7tU2r+T/uROuFZ+O7nfKSQk/WSS5Xy6E\nByLKktmCtzYdyx/rqVnYdCO7P9dNBwPe6OmyZtSGrXsTRlIZkVYQsfc9dAJjKNSM\nEDvSjmJqg/fqRlFdbOg/xHo8G82IOKxlFTqmH5YL+BU/lS4GxucdEdSAV+znNxZX\nxVPXhCHrUwKBgQCko02bVYpAAMpabNvQMxmrr7T3ka+nRNpLLxXYOdM7b8KFo0MF\nHsB4+jzLRAAefnUeffP4cW4BufJmHk4ZQfl+ADaVLUnu5zPnbQoqJNXvZhuGo5FT\nPD06RHCbI6GJ+pdO7LOBLI+WTY1CC4pLJyvjSaqLqLhoZuUAlLyGWVmBSQKBgHaQ\n407NrRJY3yqU/9bkDDftZBGpMTqY7VaYCShMJBjVjPTqwg6BSUMc5QlelyTj72W4\nOjUOKr4dwMM0Fi5mjStEuBS3Lpn+d3zbtk3HKQJroltod4/CcLGDMF4+faiQCZ3V\njZhBgqcj6CxO/v3I3MLoTRJnll9IF5Be3Gl+MQINAoGBAJrSsYf4YWFnaoZDILpx\nwjjkERXRdWvRlunbnAnsRN3jkWDGVUiCGj5w6F6BE6Pf8Tr1I6PMDMNjueoXV2KB\nTioxqAF7atY0LC/aR5mbJXzZyNDHJo+/vbvYz7fSx5l8jvsu6inIZqAx/FcKM7gu\nlHAB3+/tZ06n55fZ7au2ZggH\n-----END PRIVATE KEY-----\n",
  "client_email": "andreli-socios-sync@civic-beaker-244713.iam.gserviceaccount.com",
  "client_id": "102785991489399162756",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token"
};

const FOLDER_NAME = 'ANDRELI SOCIOS';
const FILE_PREFIX = 'PADRON_MOROSIDAD_Html_';

// ============== FUNCIONES B√ÅSICAS ==============
function getPeruvianDate(date=new Date()){const peruTime=new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"}));return peruTime;}
function getPeruvianDateString(date=new Date()){const options={timeZone:'America/Lima',year:'numeric',month:'2-digit',day:'2-digit'};const peruDateStr=date.toLocaleDateString('en-CA',options);return peruDateStr;}
function getPeruvianISOString(date=new Date()){return new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"})).toISOString();}
function formatPeruvianTime(dateString){const date=new Date(dateString);return date.toLocaleTimeString('es-PE',{timeZone:'America/Lima',hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function formatPeruvianDate(dateString){const[year,month,day]=dateString.split('-');return`${day}/${month}/${year}`;}
function formatNumber(num){if(typeof num!=='number'||isNaN(num))return'0.00';return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function formatInteger(num){if(typeof num!=='number'||isNaN(num))return'0';return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');}

// ============== GOOGLE DRIVE SERVICE ACCOUNT ==============

// Funci√≥n para generar JWT token
async function generateJWT() {
    const header = {
        "alg": "RS256",
        "typ": "JWT"
    };
    
    const now = Math.floor(Date.now() / 1000);
    const payload = {
        "iss": SERVICE_ACCOUNT_CREDENTIALS.client_email,
        "scope": "https://www.googleapis.com/auth/drive.readonly",
        "aud": "https://oauth2.googleapis.com/token",
        "exp": now + 3600,
        "iat": now
    };
    
    const encodedHeader = btoa(JSON.stringify(header)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    const encodedPayload = btoa(JSON.stringify(payload)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    
    const message = encodedHeader + '.' + encodedPayload;
    
    // Importar la clave privada
    const privateKey = await window.crypto.subtle.importKey(
        "pkcs8",
        pemToArrayBuffer(SERVICE_ACCOUNT_CREDENTIALS.private_key),
        {
            name: "RSASSA-PKCS1-v1_5",
            hash: "SHA-256"
        },
        false,
        ["sign"]
    );
    
    // Firmar el mensaje
    const signature = await window.crypto.subtle.sign(
        "RSASSA-PKCS1-v1_5",
        privateKey,
        new TextEncoder().encode(message)
    );
    
    const encodedSignature = btoa(String.fromCharCode(...new Uint8Array(signature)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    
    return message + '.' + encodedSignature;
}

function pemToArrayBuffer(pem) {
    const b64Lines = pem.replace(/-----BEGIN PRIVATE KEY-----/, '')
                        .replace(/-----END PRIVATE KEY-----/, '')
                        .replace(/\s/g, '');
    const byteString = atob(b64Lines);
    const byteArray = new Uint8Array(byteString.length);
    for (let i = 0; i < byteString.length; i++) {
        byteArray[i] = byteString.charCodeAt(i);
    }
    return byteArray.buffer;
}

// Funci√≥n para obtener token de acceso
async function getAccessToken() {
    try {
        const jwt = await generateJWT();
        
        const response = await fetch('https://oauth2.googleapis.com/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`
        });
        
        const data = await response.json();
        return data.access_token;
    } catch (error) {
        console.error('Error obteniendo access token:', error);
        throw error;
    }
}

// Funci√≥n principal de sincronizaci√≥n
async function syncFromDrive() {
    try {
        updateSyncButton(true);
        showSyncStatus('Conectando con Google Drive...', 'loading');
        
        // Obtener token de acceso
        const accessToken = await getAccessToken();
        
        // Buscar carpeta
        showSyncStatus('Buscando carpeta ANDRELI SOCIOS...', 'loading');
        const folderId = await findFolder(accessToken);
        
        if (!folderId) {
            throw new Error('No se encontr√≥ la carpeta "ANDRELI SOCIOS" o no tienes acceso a ella');
        }
        
        // Buscar archivo m√°s reciente
        showSyncStatus('Buscando archivo Excel m√°s reciente...', 'loading');
        const latestFile = await findLatestExcelFile(accessToken, folderId);
        
        // Descargar archivo
        showSyncStatus(`Descargando ${latestFile.name}...`, 'loading');
        const fileData = await downloadFile(accessToken, latestFile.id);
        
        // Procesar archivo
        showSyncStatus('Procesando datos...', 'loading');
        await processExcelData(fileData, latestFile.name);
        
        showSyncStatus(`‚úÖ Sincronizaci√≥n exitosa: ${latestFile.name}`, 'success');
        updateDisplay();
        
    } catch (error) {
        console.error('Error en sincronizaci√≥n:', error);
        showSyncStatus(`‚ùå Error: ${error.message}`, 'error');
    } finally {
        updateSyncButton(false);
    }
}

async function findFolder(accessToken) {
    const response = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        }
    );
    
    const data = await response.json();
    return data.files && data.files.length > 0 ? data.files[0].id : null;
}

async function findLatestExcelFile(accessToken, folderId) {
    const response = await fetch(
        `https://www.googleapis.com/drive/v3/files?q=parents in '${folderId}' and name contains '${FILE_PREFIX}' and trashed=false&orderBy=modifiedTime desc`,
        {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        }
    );
    
    const data = await response.json();
    if (!data.files || data.files.length === 0) {
        throw new Error('No se encontraron archivos Excel en la carpeta');
    }
    
    return data.files[0];
}

async function downloadFile(accessToken, fileId) {
    const response = await fetch(
        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
        {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        }
    );
    
    if (!response.ok) {
        throw new Error('Error al descargar el archivo');
    }
    
    return await response.arrayBuffer();
}

async function processExcelData(fileData, fileName) {
    try {
        const workbook = XLSX.read(new Uint8Array(fileData), {
            type: 'array',
            cellDates: false,
            raw: true
        });
        
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
            header: 1,
            raw: true
        });
        
        if (jsonData.length < 2) {
            throw new Error('El archivo Excel est√° vac√≠o o no tiene el formato correcto');
        }
        
        const headers = jsonData[0];
        console.log('Headers encontrados:', headers);
        
        const columnMap = {
            id: headers.indexOf('Id'),
            nombre: headers.indexOf('Nombre'),
            telefono: headers.findIndex(h => h && h.toString().includes('Tel')),
            fechaDesem: headers.findIndex(h => h && h.toString().includes('Fecha Desem')),
            monto: headers.indexOf('Monto'),
            plz: headers.indexOf('Plz'),
            frecPago: headers.findIndex(h => h && h.toString().includes('Frec Pago')),
            montoCuota: headers.findIndex(h => h && h.toString().includes('Monto Cuota')),
            mora: headers.indexOf('Mora'),
            totalAtraso: headers.findIndex(h => h && h.toString().includes('Total Atraso')),
            diaAtr: headers.findIndex(h => h && h.toString().includes('Dia Atr')),
            totalDeuda: headers.findIndex(h => h && h.toString().includes('Total Deuda'))
        };
        
        const data = jsonData.slice(1);
        let updatedCount = 0;
        let addedCount = 0;
        let errorCount = 0;
        
        for (let i = 0; i < data.length; i++) {
            const row = data[i];
            if (!row[columnMap.id] || !row[columnMap.nombre]) continue;
            
            try {
                const id = row[columnMap.id].toString().trim();
                const name = cleanText(row[columnMap.nombre].toString().trim());
                const phone = columnMap.telefono >= 0 && row[columnMap.telefono] ? row[columnMap.telefono].toString().trim() : '';
                const disbursementDate = columnMap.fechaDesem >= 0 && row[columnMap.fechaDesem] ? formatExcelDate(row[columnMap.fechaDesem]) : '';
                const monto = columnMap.monto >= 0 && row[columnMap.monto] ? parseExcelNumber(row[columnMap.monto]) : 0;
                const term = columnMap.plz >= 0 && row[columnMap.plz] ? parseInt(row[columnMap.plz]) : 0;
                const frequency = columnMap.frecPago >= 0 && row[columnMap.frecPago] ? mapFrequency(row[columnMap.frecPago].toString().trim()) : '';
                const quota = columnMap.montoCuota >= 0 && row[columnMap.montoCuota] ? parseExcelNumber(row[columnMap.montoCuota]) : 0;
                const mora = columnMap.mora >= 0 && row[columnMap.mora] ? parseExcelNumber(row[columnMap.mora]) : 0;
                const totalAtraso = columnMap.totalAtraso >= 0 && row[columnMap.totalAtraso] ? parseExcelNumber(row[columnMap.totalAtraso]) : 0;
                const diasAtraso = columnMap.diaAtr >= 0 && row[columnMap.diaAtr] ? parseInt(row[columnMap.diaAtr]) : 0;
                const totalDeuda = columnMap.totalDeuda >= 0 && row[columnMap.totalDeuda] ? parseExcelNumber(row[columnMap.totalDeuda]) : 0;
                
                if (!disbursementDate || !term || term <= 0 || !frequency || !quota || quota <= 0) {
                    errorCount++;
                    continue;
                }
                
                const existingClient = clients.find(c => c.id === id);
                if (existingClient) {
                    existingClient.name = name;
                    existingClient.phone = phone;
                    existingClient.disbursementDate = disbursementDate;
                    existingClient.term = term;
                    existingClient.frequency = frequency;
                    existingClient.quota = quota;
                    existingClient.monto = monto;
                    existingClient.mora = mora;
                    existingClient.totalAtraso = totalAtraso;
                    existingClient.diasAtraso = diasAtraso;
                    existingClient.totalDeuda = totalDeuda;
                    updatedCount++;
                } else {
                    const newClient = {
                        id: id,
                        name: name,
                        phone: phone,
                        disbursementDate: disbursementDate,
                        frequency: frequency,
                        quota: quota,
                        term: term,
                        monto: monto,
                        mora: mora,
                        totalAtraso: totalAtraso,
                        diasAtraso: diasAtraso,
                        totalDeuda: totalDeuda,
                        createdAt: getPeruvianISOString()
                    };
                    clients.push(newClient);
                    addedCount++;
                }
            } catch (err) {
                errorCount++;
            }
        }
        
        saveData();
        
        console.log(`Archivo procesado desde Drive:
        - Socios nuevos: ${addedCount}
        - Socios actualizados: ${updatedCount}
        - Errores: ${errorCount}`);
        
    } catch (error) {
        console.error('Error al procesar datos del Excel:', error);
        throw error;
    }
}

function showSyncStatus(message, type = 'loading') {
    const statusDiv = document.getElementById('syncStatus');
    statusDiv.className = `sync-status sync-${type}`;
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
    
    if (type === 'success' || type === 'error') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
}

function updateSyncButton(isLoading = false) {
    const syncBtn = document.getElementById('syncBtn');
    const syncIcon = document.getElementById('syncIcon');
    const syncText = document.getElementById('syncText');
    
    if (isLoading) {
        syncBtn.disabled = true;
        syncIcon.innerHTML = '<div class="loading-spinner"></div>';
        syncText.textContent = 'Sincronizando...';
    } else {
        syncBtn.disabled = false;
        syncIcon.textContent = 'üîÑ';
        syncText.textContent = 'Sincronizar';
    }
}

// ============== FUNCIONES AUXILIARES PARA EXCEL ==============
function formatExcelDate(excelDate){if(!excelDate)return'';if(excelDate instanceof Date){const year=excelDate.getFullYear();const month=(excelDate.getMonth()+1).toString().padStart(2,'0');const day=excelDate.getDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}if(typeof excelDate==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(excelDate)){return excelDate;}if(typeof excelDate==='string'){excelDate=excelDate.trim();if(excelDate.includes('/')||excelDate.includes('-')){const parts=excelDate.split(/[/-]/);if(parts.length===3){let day,month,year;if(parts[0].length===4){year=parts[0];month=parts[1].padStart(2,'0');day=parts[2].padStart(2,'0');}else{day=parts[0].padStart(2,'0');month=parts[1].padStart(2,'0');if(parts[2].length===2){const currentYear=new Date().getFullYear();const century=Math.floor(currentYear/100)*100;const yearNum=parseInt(parts[2]);if(yearNum<=currentYear%100){year=century+yearNum;}else{year=(century-100)+yearNum;}}else{year=parts[2];}}const dateObj=new Date(parseInt(year),parseInt(month)-1,parseInt(day));if(!isNaN(dateObj.getTime())){return`${year}-${month}-${day}`;}}}}else if(typeof excelDate==='number'){const utcDays=Math.floor(excelDate-25569);const utcValue=utcDays*86400;const dateInfo=new Date(utcValue*1000);const year=dateInfo.getUTCFullYear();if(year<2020||year>2030){console.warn('Fecha fuera de rango:',year);return'';}const month=(dateInfo.getUTCMonth()+1).toString().padStart(2,'0');const day=dateInfo.getUTCDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}return'';}
function parseExcelNumber(value){if(typeof value==='number')return value;if(typeof value==='string'){value=value.trim();value=value.replace(/,/g,'');value=value.replace(/\s/g,'');value=value.replace('S/.','');value=value.replace('S/','');const num=parseFloat(value);return isNaN(num)?0:num;}return 0;}
function cleanText(text){if(!text)return text;return text.replace(/ÔøΩ/g,'√±').replace(/√ë/g,'√ë').replace(/√±/g,'√±').replace(/√É¬±/g,'√±').replace(/√É'/g,'√ë').replace(/√É¬°/g,'√°').replace(/√É¬©/g,'√©').replace(/√É¬≠/g,'√≠').replace(/√É¬≥/g,'√≥').replace(/√É¬∫/g,'√∫').replace(/√É/g,'√Å').replace(/√É‚Ä∞/g,'√â').replace(/√É/g,'√ç').replace(/√É"/g,'√ì').replace(/√É≈°/g,'√ö').replace(/√°/g,'√°').replace(/√©/g,'√©').replace(/√≠/g,'√≠').replace(/√≥/g,'√≥').replace(/√∫/g,'√∫').replace(/√É¬º/g,'√º').replace(/√É¬§/g,'√§').replace(/√É¬∂/g,'√∂').replace(/√Ç¬ø/g,'¬ø').replace(/√Ç¬°/g,'¬°').replace(/√¢‚Ç¨≈ì/g,'"').replace(/√¢‚Ç¨/g,'"').replace(/√¢‚Ç¨‚Ñ¢/g,"'").replace(/√¢‚Ç¨Àú/g,"'").replace(/√¢‚Ç¨"/g,'‚Äì').replace(/√¢‚Ç¨"/g,'‚Äî').replace(/\u00f1/g,'√±').replace(/\u00d1/g,'√ë').replace(/\u00e1/g,'√°').replace(/\u00e9/g,'√©').replace(/\u00ed/g,'√≠').replace(/\u00f3/g,'√≥').replace(/\u00fa/g,'√∫').replace(/\u00c1/g,'√Å').replace(/\u00c9/g,'√â').replace(/\u00cd/g,'√ç').replace(/\u00d3/g,'√ì').replace(/\u00da/g,'√ö');}
function mapFrequency(freq){if(!freq)return'';const upperFreq=freq.toString().toUpperCase().trim();const mappings={'DIAR':'DIARIO','SEMA':'SEMANAL','QUIN':'QUINCENAL','MENS':'MENSUAL','DIARIO':'DIARIO','DIARIA':'DIARIO','SEMANAL':'SEMANAL','QUINCENAL':'QUINCENAL','MENSUAL':'MENSUAL','D':'DIARIO','S':'SEMANAL','Q':'QUINCENAL','M':'MENSUAL'};if(mappings[upperFreq]){return mappings[upperFreq];}if(upperFreq.includes('DIAR'))return'DIARIO';if(upperFreq.includes('SEMA'))return'SEMANAL';if(upperFreq.includes('QUIN'))return'QUINCENAL';if(upperFreq.includes('MENS'))return'MENSUAL';console.warn('Frecuencia no reconocida:',freq);return'';}

// ============== RESTO DE FUNCIONES ORIGINALES ==============
function init(){loadData();setToday();updateDisplay();document.addEventListener('click',function(e){if(!e.target.closest('.form-group')){hideClientDropdown();}});}
function loadData(){const savedClients=localStorage.getItem('clients');const savedPayments=localStorage.getItem('payments');if(savedClients)clients=JSON.parse(savedClients);if(savedPayments)payments=JSON.parse(savedPayments);}
function saveData(){localStorage.setItem('clients',JSON.stringify(clients));localStorage.setItem('payments',JSON.stringify(payments));}
function setToday(){const today=getPeruvianDateString();document.getElementById('dateFilter').value=today;updateDisplay();}
function updateDisplay(){const selectedDate=document.getElementById('dateFilter').value;updateStats(selectedDate);updateDebtClients();updateClientsList(selectedDate);updatePaymentsList(selectedDate);}

// [Aqu√≠ ir√≠an TODAS las dem√°s funciones originales del sistema...]
// Por brevedad, incluyo solo las principales. El resto ser√≠an las mismas funciones que ya tienes.

function shouldPayOnDate(client,checkDate){if(!client.disbursementDate||!client.frequency){return false;}const[disbYear,disbMonth,disbDay]=client.disbursementDate.split('-').map(n=>parseInt(n));const[checkYear,checkMonth,checkDay]=checkDate.split('-').map(n=>parseInt(n));if(isNaN(disbYear)||isNaN(disbMonth)||isNaN(disbDay)||isNaN(checkYear)||isNaN(checkMonth)||isNaN(checkDay)){console.warn('Fecha inv√°lida en shouldPayOnDate:',client.disbursementDate,checkDate);return false;}const disbursementDate=new Date(disbYear,disbMonth-1,disbDay);const targetDate=new Date(checkYear,checkMonth-1,checkDay);if(targetDate<=disbursementDate){return false;}const daysDiff=Math.floor((targetDate-disbursementDate)/(1000*60*60*24));const dayOfWeek=targetDate.getDay();switch(client.frequency){case'DIARIO':return dayOfWeek>=1&&dayOfWeek<=5&&daysDiff>=1;case'SEMANAL':return daysDiff>0&&daysDiff%7===0;case'QUINCENAL':return daysDiff>0&&daysDiff%15===0;case'MENSUAL':if(daysDiff<28)return false;const monthsDiff=(checkYear-disbYear)*12+(checkMonth-disbMonth);if(monthsDiff<1)return false;if(checkDay===disbDay){return true;}const lastDayOfTargetMonth=new Date(checkYear,checkMonth,0).getDate();if(checkDay===lastDayOfTargetMonth&&disbDay>lastDayOfTargetMonth){return true;}if(disbDay>28&&checkDay===lastDayOfTargetMonth){return true;}return false;default:console.warn('Frecuencia no reconocida:',client.frequency);return false;}}

function updateStats(date){const dayPayments=payments.filter(p=>p.date===date);const total=dayPayments.reduce((sum,p)=>sum+p.amount,0);const uniqueClients=new Set(dayPayments.map(p=>p.clientId)).size;const cashTotal=dayPayments.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeTotal=dayPayments.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);document.getElementById('totalPaid').textContent=`S/${formatNumber(total)}`;document.getElementById('clientsPaid').textContent=formatInteger(uniqueClients);document.getElementById('totalCash').textContent=`S/${formatNumber(cashTotal)}`;document.getElementById('totalYape').textContent=`S/${formatNumber(yapeTotal)}`;}

function updateDebtClients(){const debtClients=clients.filter(c=>c.diasAtraso>0);const debtSection=document.getElementById('debtClientsSection');const debtList=document.getElementById('debtClientsList');if(debtClients.length===0){debtSection.style.display='none';return;}debtSection.style.display='block';debtList.innerHTML=debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).map(client=>{return`<div class="client-item in-debt" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;"><div style="font-weight:600;font-size:16px;color:#333;margin-bottom:8px;">${client.name}</div><div style="display:flex;align-items:center;gap:12px;margin-bottom:5px;flex-wrap:wrap;"><span class="client-status status-overdue">${client.diasAtraso} d√≠as atraso</span><span class="debt-badge">Mora: S/${formatNumber(client.mora||0)}</span><span style="background:#dc3545;color:white;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;">Total: S/${formatNumber(client.totalAtraso||0)}</span></div></div><button class="btn-circle btn-pay" onclick="event.stopPropagation();quickPaymentDebt('${client.id}');" title="Pago r√°pido">üí∞</button></div>`;}).join('');}

function updateClientsList(date){const clientsList=document.getElementById('clientsList');const dayPayments=payments.filter(p=>p.date===date);const clientsToPayToday=clients.filter(client=>shouldPayOnDate(client,date));if(clientsToPayToday.length===0){clientsList.innerHTML='<div class="empty-state">No hay socios que deban pagar hoy</div>';return;}clientsList.innerHTML=clientsToPayToday.map(client=>{const clientPayments=dayPayments.filter(p=>p.clientId===client.id);const hasPaid=clientPayments.length>0;const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const freqClass={'DIARIO':'freq-diario','SEMANAL':'freq-semanal','QUINCENAL':'freq-quincenal','MENSUAL':'freq-mensual'}[client.frequency];const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;return`<div class="client-item" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;"><div style="font-weight:600;font-size:16px;color:#333;margin-bottom:8px;">${client.name}</div><div style="display:flex;align-items:center;gap:12px;margin-bottom:5px;"><span class="client-status ${hasPaid?'status-paid':'status-pending'}">${hasPaid?'Pag√≥':'Pendiente'}</span><span class="frequency-badge ${freqClass}" style="text-transform:uppercase;font-size:11px;">${client.frequency}</span>${displayQuota?`<span class="client-quota" style="font-size:14px;">S/${formatNumber(displayQuota)}</span>`:''}</div>${hasPaid?`<div style="font-size:12px;color:#666;">Pag√≥:S/${formatNumber(totalPaid)}</div>`:''}</div><button class="btn-circle btn-pay" onclick="event.stopPropagation();quickPayment('${client.id}');" title="Pago r√°pido">üí∞</button></div>`;}).join('');}

function updatePaymentsList(date){const paymentsList=document.getElementById('paymentsList');const dayPayments=payments.filter(p=>p.date===date);if(dayPayments.length===0){paymentsList.innerHTML='<div class="empty-state">No hay pagos registrados</div>';return;}const groupedPayments={};dayPayments.forEach(payment=>{if(!groupedPayments[payment.timestamp]){groupedPayments[payment.timestamp]=[];}groupedPayments[payment.timestamp].push(payment);});const sortedGroups=Object.entries(groupedPayments).sort((a,b)=>new Date(b[0])-new Date(a[0]));paymentsList.innerHTML=sortedGroups.map(([timestamp,paymentGroup])=>{const client=clients.find(c=>c.id===paymentGroup[0].clientId);const totalAmount=paymentGroup.reduce((sum,p)=>sum+p.amount,0);const hasCash=paymentGroup.some(p=>p.method==='efectivo');const hasYape=paymentGroup.some(p=>p.method==='yape');const isMixed=hasCash&&hasYape;let methodDisplay='';if(isMixed){const cashAmount=paymentGroup.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeAmount=paymentGroup.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);methodDisplay=`<span class="payment-method method-mixto">üí∞ Mixto</span><div style="font-size:11px;color:#666;margin-top:3px;">üíµ S/${formatNumber(cashAmount)} | üì± S/${formatNumber(yapeAmount)}</div>`;}else{const payment=paymentGroup[0];const methodIcon=payment.method==='yape'?'üì±':'üíµ';const methodClass=payment.method==='yape'?'method-yape':'method-efectivo';const methodText=payment.method==='yape'?'Yape':'Efectivo';methodDisplay=`<span class="payment-method ${methodClass}">${methodIcon} ${methodText}</span>`;}return`<div class="payment-item"><div class="payment-id">ID:${client?client.id:'N/A'}</div><div class="payment-client">${client?client.name:'Socio eliminado'}${methodDisplay}</div><div class="payment-details"><span>${paymentGroup[0].note||'Sin nota'}</span><span class="payment-amount">S/${formatNumber(totalAmount)}</span></div><div class="payment-details"><span>${formatPeruvianTime(paymentGroup[0].timestamp)}</span><button class="btn-danger" onclick="deletePaymentGroup('${timestamp}')">Eliminar</button></div></div>`;}).join('');}

function searchAllClients(){const searchTerm=document.getElementById('generalClientSearch').value.toLowerCase();const resultsContainer=document.getElementById('searchResults');if(searchTerm===''){resultsContainer.style.display='none';return;}const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||client.id.includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));resultsContainer.style.display='block';if(filteredClients.length===0){resultsContainer.innerHTML='<div class="no-results">No se encontraron socios</div>';}else{resultsContainer.innerHTML=filteredClients.map(client=>`<div class="search-result-item" onclick="showClientDetailsModal('${client.id}')"><div style="font-size:11px;color:#999;">ID:${client.id}</div><div style="font-weight:600;">${client.name}</div>${client.phone?`<div style="font-size:13px;color:#666;">${client.phone}</div>`:''}</div>`).join('');}}

function showAddClientModal(){document.getElementById('clientId').value='';document.getElementById('clientName').value='';document.getElementById('clientPhone').value='';document.getElementById('clientDisbursementDate').value='';document.getElementById('clientFrequency').value='';document.getElementById('clientQuota').value='';document.getElementById('clientTerm').value='';showModal('addClientModal');}

function showAddPaymentModal(){if(clients.length===0){alert('Primero debes agregar al menos un socio');return;}document.getElementById('clientSearchModal').value='';document.getElementById('selectedClientId').value='';document.getElementById('paymentAmountSingle').value='';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';document.getElementById('paymentNote').value='';updatePaymentTotal();selectedPaymentType='';document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('paymentInputsContainer').style.display='none';showModal('addPaymentModal');}

function addClient(event){event.preventDefault();const id=document.getElementById('clientId').value.trim();const name=document.getElementById('clientName').value.trim();const phone=document.getElementById('clientPhone').value.trim();const disbursementDate=document.getElementById('clientDisbursementDate').value;const frequency=document.getElementById('clientFrequency').value;const quota=parseFloat(document.getElementById('clientQuota').value);const term=parseInt(document.getElementById('clientTerm').value);if(clients.find(c=>c.id===id)){alert('Ya existe un socio con ese ID');return;}const newClient={id:id,name:name,phone:phone,disbursementDate:disbursementDate,frequency:frequency,quota:quota,term:term,createdAt:getPeruvianISOString()};clients.push(newClient);saveData();updateDisplay();closeModal('addClientModal');}

function addPayment(event){event.preventDefault();const clientId=document.getElementById('selectedClientId').value;const note=document.getElementById('paymentNote').value.trim();const date=document.getElementById('dateFilter').value;if(!clientId){alert('Por favor selecciona un socio de la lista');return;}if(!selectedPaymentType){alert('Por favor selecciona un tipo de pago');return;}let cashAmount=0;let yapeAmount=0;if(selectedPaymentType==='efectivo'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto v√°lido');return;}cashAmount=amount;}else if(selectedPaymentType==='yape'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto v√°lido');return;}yapeAmount=amount;}else if(selectedPaymentType==='parcial'){cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;if(cashAmount===0&&yapeAmount===0){alert('Por favor ingresa al menos un monto');return;}}const timestamp=getPeruvianISOString();if(cashAmount>0){const cashPayment={id:Date.now().toString()+'_cash',clientId:clientId,amount:cashAmount,method:'efectivo',note:note+(yapeAmount>0?' (Pago parcial - Efectivo)':''),date:date,timestamp:timestamp};payments.push(cashPayment);}if(yapeAmount>0){const yapePayment={id:Date.now().toString()+'_yape',clientId:clientId,amount:yapeAmount,method:'yape',note:note+(cashAmount>0?' (Pago parcial - Yape)':''),date:date,timestamp:timestamp};payments.push(yapePayment);}saveData();updateDisplay();closeModal('addPaymentModal');}

function selectPaymentType(type){selectedPaymentType=type;const buttons=document.querySelectorAll('.payment-type-btn');buttons.forEach(btn=>btn.classList.remove('active'));event.target.closest('.payment-type-btn').classList.add('active');document.getElementById('paymentInputsContainer').style.display='block';const clientId=document.getElementById('selectedClientId').value;if(clientId){const client=clients.find(c=>c.id===clientId);if(client){const montoSugerido=client.diasAtraso>0?client.totalAtraso:client.quota;if(type==='parcial'){document.getElementById('singlePaymentInputs').style.display='none';document.getElementById('partialPaymentInputs').style.display='block';document.getElementById('paymentAmountCash').value=montoSugerido||'0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else{document.getElementById('partialPaymentInputs').style.display='none';document.getElementById('singlePaymentInputs').style.display='block';const label=type==='efectivo'?'üíµ Monto en Efectivo':'üì± Monto en Yape';document.getElementById('singlePaymentLabel').textContent=label;document.getElementById('paymentAmountSingle').value=montoSugerido||'';}}}else{if(type==='parcial'){document.getElementById('singlePaymentInputs').style.display='none';document.getElementById('partialPaymentInputs').style.display='block';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else{document.getElementById('partialPaymentInputs').style.display='none';document.getElementById('singlePaymentInputs').style.display='block';const label=type==='efectivo'?'üíµ Monto en Efectivo':'üì± Monto en Yape';document.getElementById('singlePaymentLabel').textContent=label;document.getElementById('paymentAmountSingle').value='';}}}

function updatePaymentTotal(){const cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;const yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;const total=cashAmount+yapeAmount;document.getElementById('paymentTotal').textContent=`S/${formatNumber(total)}`;}

function showClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='block';filterModalClients();}

function hideClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='none';}

function filterModalClients(){const searchTerm=document.getElementById('clientSearchModal').value.toLowerCase();const dropdown=document.getElementById('clientDropdown');const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));if(filteredClients.length===0){dropdown.innerHTML='<div class="no-results">No se encontraron socios</div>';}else{dropdown.innerHTML=filteredClients.map(client=>{const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;return`<div class="dropdown-item" onclick="selectClient('${client.id}','${client.name}',${displayQuota||0})"><div class="dropdown-item-name">${client.name}${client.diasAtraso>0?'<span class="debt-badge" style="margin-left:8px;font-size:10px;">En mora</span>':''}</div>${client.phone?`<div class="dropdown-item-phone">${client.phone}</div>`:''}<div style="font-size:12px;color:#1a5490;margin-top:3px;">Sugerido: S/${formatNumber(displayQuota||0)}</div></div>`;}).join('');}}

function selectClient(clientId,clientName,quota){document.getElementById('selectedClientId').value=clientId;document.getElementById('clientSearchModal').value=clientName;hideClientDropdown();const client=clients.find(c=>c.id===clientId);if(!client)return;let montoSugerido=0;if(client.diasAtraso>0){montoSugerido=client.totalAtraso||0;}else{montoSugerido=client.quota||0;}if(selectedPaymentType){if(selectedPaymentType==='parcial'&&montoSugerido>0){document.getElementById('paymentAmountCash').value=montoSugerido;document.getElementById('paymentAmountYape').value=0;updatePaymentTotal();}else if(selectedPaymentType!=='parcial'&&montoSugerido>0){document.getElementById('paymentAmountSingle').value=montoSugerido;}}}

function showModal(modalId){const modal=document.getElementById(modalId);scrollPosition=window.pageYOffset||document.documentElement.scrollTop;modal.style.display='block';document.body.style.overflow='hidden';document.body.style.position='fixed';document.body.style.width='100%';document.body.style.top=`-${scrollPosition}px`;requestAnimationFrame(()=>{modal.classList.add('show');});}

function closeModal(modalId){const modal=document.getElementById(modalId);const modalContent=modal.querySelector('.modal-content');modalContent.classList.add('closing');modal.classList.remove('show');setTimeout(()=>{modal.style.display='none';modalContent.classList.remove('closing');document.body.style.overflow='';document.body.style.position='';document.body.style.width='';document.body.style.top='';window.scrollTo(0,scrollPosition);},300);if(modalId==='addPaymentModal'){document.getElementById('clientSearchModal').value='';document.getElementById('selectedClientId').value='';document.getElementById('paymentAmountSingle').value='';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();hideClientDropdown();selectedPaymentType='';document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('paymentInputsContainer').style.display='none';}}

function deletePaymentGroup(timestamp){if(confirm('¬øEst√°s seguro de eliminar este pago?')){payments=payments.filter(p=>p.timestamp!==timestamp);saveData();updateDisplay();}}

function quickPayment(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;showAddPaymentModal();setTimeout(()=>{document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;document.getElementById('paymentNote').value='Pago r√°pido';},100);}

function quickPaymentDebt(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;showAddPaymentModal();setTimeout(()=>{document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;document.getElementById('paymentNote').value='Pago de mora';},100);}

function showClientDetailsModal(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;alert(`Detalles del Socio:\n\nID: ${client.id}\nNombre: ${client.name}\nTel√©fono: ${client.phone||'No registrado'}\nCuota: S/${formatNumber(client.quota||0)}\nPlazo: ${client.term||0} cuotas\nFrecuencia: ${client.frequency||'N/A'}${client.diasAtraso>0?`\n\n‚ö†Ô∏è EN MORA:\nD√≠as de atraso: ${client.diasAtraso}\nMora: S/${formatNumber(client.mora||0)}\nTotal atraso: S/${formatNumber(client.totalAtraso||0)}`:''}`);} 

function showMorosidadModal(){const debtClients=clients.filter(c=>c.diasAtraso>0);if(debtClients.length===0){alert('No hay socios en mora actualmente');return;}let message='üìä REPORTE DE MOROSIDAD\n\n';message+=`Total socios en mora: ${debtClients.length}\n\n`;debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).forEach(client=>{message+=`‚Ä¢ ${client.name} (ID: ${client.id})\n`;message+=`  D√≠as atraso: ${client.diasAtraso}\n`;message+=`  Mora: S/${formatNumber(client.mora||0)}\n`;message+=`  Total atraso: S/${formatNumber(client.totalAtraso||0)}\n\n`;});const totalAtraso=debtClients.reduce((sum,c)=>sum+(c.totalAtraso||0),0);message+=`üí∞ TOTAL GENERAL: S/${formatNumber(totalAtraso)}`;alert(message);}

function handleExcelUpload(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=async function(e){try{await processExcelData(e.target.result,file.name);alert('‚úÖ Archivo Excel procesado exitosamente');updateDisplay();}catch(error){alert('‚ùå Error al procesar archivo: '+error.message);}finally{event.target.value='';}};reader.readAsArrayBuffer(file);}

function openWhatsApp(phone){if(!phone||phone.trim()===''){alert('Este socio no tiene n√∫mero de tel√©fono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const whatsappUrl=`https://wa.me/${cleanPhone.replace('+','')}`;window.open(whatsappUrl,'_blank');}

function makeCall(phone){if(!phone||phone.trim()===''){alert('Este socio no tiene n√∫mero de tel√©fono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const callUrl=`tel:${cleanPhone}`;window.location.href=callUrl;}

document.getElementById('dateFilter').addEventListener('change',updateDisplay);
window.onclick=function(event){if(event.target.classList.contains('modal')){const modalId=event.target.id;closeModal(modalId);}};

init();
</script>
</body>
</html>

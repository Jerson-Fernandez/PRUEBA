<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Sistema de Pagos Andreli</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Control Pagos">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#667eea">
<meta name="format-detection" content="telephone=no">
<style>*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background-color:#f5f5f5;color:#333;min-height:100vh;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior-y:contain;-webkit-user-select:none;user-select:none;scroll-behavior:smooth}input,textarea{-webkit-user-select:text!important;user-select:text!important;-webkit-touch-callout:default!important}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding-top:calc(20px + env(safe-area-inset-top));position:sticky;top:0;z-index:100}.header h1{font-size:24px;font-weight:600}.container{padding:20px;max-width:600px;margin:0 auto;padding-bottom:calc(20px + env(safe-area-inset-bottom))}.stats-card{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.payment-method{display:inline-block;padding:3px 8px;border-radius:6px;font-size:12px;font-weight:500;margin-left:8px}.method-efectivo{background:#e8f5e9;color:#2e7d32}.method-yape{background:#e3f2fd;color:#1565c0}.method-mixto{background:#fff3cd;color:#856404}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:10px}.stat-item{text-align:center}.stat-value{font-size:28px;font-weight:bold;color:#667eea}.stat-label{font-size:14px;color:#666;margin-top:5px}.section-title{font-size:18px;font-weight:600;margin-bottom:15px;color:#333}.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:15px 30px;border-radius:10px;font-size:16px;font-weight:600;width:100%;cursor:pointer;transition:transform 0.2s;margin-bottom:15px;-webkit-appearance:none;appearance:none;touch-action:manipulation}.btn-primary:active{transform:scale(0.98);opacity:0.9}.btn-secondary{background:#f0f0f0;color:#333;border:none;padding:12px 20px;border-radius:8px;font-size:14px;cursor:pointer;transition:background 0.2s;-webkit-appearance:none;appearance:none}.btn-secondary:active{background:#e0e0e0}.client-list{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.client-item{padding:20px 15px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background 0.2s;display:flex;justify-content:space-between;align-items:center;min-height:60px;-webkit-tap-highlight-color:rgba(0,0,0,0.1)}.client-item:active{background:#f9f9f9}.client-item:last-child{border-bottom:none}.client-item.in-debt{background:#fff5f5;border-left:4px solid #dc3545}.client-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}.client-info{flex:1;min-width:0}.client-name{font-weight:600;color:#333;font-size:16px;line-height:1.3;margin-bottom:5px;word-wrap:break-word}.client-payment-info{font-size:13px;color:#666;display:flex;align-items:center;flex-wrap:wrap;gap:8px}.client-status{font-size:12px;padding:4px 10px;border-radius:12px;font-weight:500;white-space:nowrap}.status-paid{background:#d4edda;color:#155724}.status-pending{background:#fff3cd;color:#856404}.status-overdue{background:#f8d7da;color:#721c24}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0);z-index:1000;transition:background-color 0.25s ease-out}.modal.show{background:rgba(0,0,0,0.5)}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.modal-content{background:white;padding:20px;width:calc(100% - 40px);max-width:500px;border-radius:15px;max-height:calc(100vh - 40px);overflow-y:auto;-webkit-overflow-scrolling:touch;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);animation:slideIn 0.3s}@keyframes slideIn{from{transform:translate(-50%,-50%) translateY(-50px);opacity:0}to{transform:translate(-50%,-50%) translateY(0);opacity:1}}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-title{font-size:20px;font-weight:600}.close-btn{font-size:24px;cursor:pointer;color:#999;background:none;border:none;-webkit-appearance:none;appearance:none}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-weight:500;color:#333}.form-input{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;transition:border 0.2s;-webkit-appearance:none;appearance:none;background-color:white;touch-action:manipulation;-webkit-user-select:text!important;user-select:text!important}.form-input:focus{outline:none;border-color:#667eea;font-size:16px}input[type="date"]{min-height:44px;padding:12px}.payment-history{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.payments-container{height:720px;overflow-y:auto;-webkit-overflow-scrolling:touch}.payment-item{padding:12px;border-bottom:1px solid #f0f0f0}.payment-item:last-child{border-bottom:none}.payment-client{font-weight:500;color:#333}.payment-details{display:flex;justify-content:space-between;margin-top:5px;font-size:14px;color:#666}.payment-amount{color:#28a745;font-weight:600}.empty-state{text-align:center;padding:40px;color:#999}.search-container{margin-bottom:15px}.search-input{margin-bottom:0;background:#f8f9fa;border:1px solid #e0e0e0;-webkit-user-select:text!important;user-select:text!important;-webkit-touch-callout:default!important}.search-input:focus{background:white;border-color:#667eea}.client-item.hidden{display:none}.client-dropdown{position:absolute;background:white;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:1001;width:100%;box-shadow:0 4px 10px rgba(0,0,0,0.1)}.dropdown-item{padding:12px;cursor:pointer;border-bottom:1px solid #f0f0f0;transition:background 0.2s}.dropdown-item:hover{background:#f8f9fa}.dropdown-item:last-child{border-bottom:none}.dropdown-item-name{font-weight:500;color:#333}.dropdown-item-phone{font-size:12px;color:#666;margin-top:2px}.form-group{margin-bottom:20px;position:relative}.clients-container{height:456px;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}.no-results{text-align:center;padding:20px;color:#999;font-style:italic}.date-filter{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.btn-danger{background:#dc3545;color:white;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;margin-left:10px;-webkit-appearance:none;appearance:none}.btn-danger:active{background:#c82333}.frequency-badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:500;margin-left:5px}.freq-diario{background:#e8f5e9;color:#2e7d32}.freq-semanal{background:#e3f2fd;color:#1565c0}.freq-quincenal{background:#fce4ec;color:#c2185b}.freq-mensual{background:#f3e5f5;color:#7b1fa2}.whatsapp-btn{background:#25D366;color:white;border:none;padding:8px 12px;border-radius:50%;font-size:16px;cursor:pointer;margin-left:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;transition:background 0.2s,transform 0.2s;-webkit-appearance:none;appearance:none}.whatsapp-btn:active{background:#128C7E;transform:scale(0.95)}.call-btn{background:#007AFF;color:white;border:none;padding:8px 12px;border-radius:50%;font-size:16px;cursor:pointer;margin-left:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;transition:background 0.2s,transform 0.2s;-webkit-appearance:none;appearance:none}.call-btn:active{background:#0056CC;transform:scale(0.95)}.client-actions{display:flex;align-items:center;gap:8px;flex-shrink:0}.client-actions button{min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}.client-quota{background:#f0f4ff;color:#1a5490;padding:2px 8px;border-radius:6px;font-size:13px;font-weight:600;margin-left:8px}.payment-id{font-size:14px;color:#666;margin-bottom:3px;font-weight:600}.general-search-container{background:white;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}.search-results{margin-top:15px;max-height:300px;overflow-y:auto;-webkit-overflow-scrolling:touch}.search-result-item{padding:15px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background 0.2s}.search-result-item:hover{background:#f9f9f9}.search-result-item:last-child{border-bottom:none}.client-detail-info{margin-top:15px;padding:15px;background:#f9f9f9;border-radius:8px}.detail-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px}.detail-label{font-weight:500;color:#666}.detail-value{color:#333;font-weight:600}.action-buttons{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}.btn-action{flex:1;padding:10px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s;-webkit-appearance:none;appearance:none;min-width:80px}.btn-call{background:#007AFF;color:white}.btn-whatsapp{background:#25D366;color:white}.btn-close-detail{background:#f0f0f0;color:#333}.btn-schedule{background:#6c757d;color:white}.btn-edit-client{background:#FFA500;color:white}.btn-delete-client{background:#FF3B30;color:white}.btn-movements{background:#9b59b6;color:white}.schedule-table{margin-top:20px;width:100%;border-collapse:collapse}.schedule-table th,.schedule-table td{padding:10px;border:1px solid #e0e0e0;text-align:left}.schedule-table th{background:#f8f9fa;font-weight:600;color:#333}.schedule-table tr:nth-child(even){background:#f8f9fa}.schedule-table .paid{background:#d4edda}.schedule-table .pending{background:#fff3cd}.schedule-table .future{background:white}.schedule-table .partial{background:#ffeaa7}#scheduleModal .modal-content{max-width:800px}.movements-list{margin-top:15px;max-height:400px;overflow-y:auto;-webkit-overflow-scrolling:touch}.movement-item{padding:15px;border-bottom:1px solid #f0f0f0;background:white;border-radius:8px;margin-bottom:10px}.movement-item:last-child{border-bottom:none;margin-bottom:0}.movement-date{font-weight:600;color:#333;font-size:16px;margin-bottom:5px}.movement-details{display:flex;justify-content:space-between;align-items:center;margin-top:8px}.movement-method{font-size:14px;color:#666}.movement-amount{font-size:18px;font-weight:bold;color:#28a745}.check-icon{color:#28a745;font-size:20px}.partial-icon{color:#f39c12;font-size:16px}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(102,126,234,0.7)}70%{box-shadow:0 0 0 20px rgba(102,126,234,0)}100%{box-shadow:0 0 0 0 rgba(102,126,234,0)}}.btn-primary,.btn-secondary,.btn-circle{transition:all 0.2s cubic-bezier(0.4,0,0.2,1);position:relative}.btn-primary:active,.btn-secondary:active,.btn-circle:active{transform:scale(0.95)}.btn-primary:hover,.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.3)}.btn-circle:hover{transform:scale(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.2)}.client-item{transition:all 0.3s ease}.client-item:hover{transform:translateX(5px);box-shadow:-5px 0 20px rgba(0,0,0,0.1)}.btn-circle{width:40px;height:40px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:all 0.2s;-webkit-appearance:none;appearance:none;flex-shrink:0}.btn-circle:active{transform:scale(0.95)}.btn-edit{background:#007AFF;color:white}.btn-pay{background:#34C759;color:white}.btn-delete{background:#FF3B30;color:white}@supports (-webkit-overflow-scrolling:touch){.payments-container,.clients-container,.search-results,.modal-content{-webkit-overflow-scrolling:touch}input[type="text"],input[type="number"],input[type="tel"],input[type="date"],select,textarea{font-size:16px!important;-webkit-appearance:none;-webkit-border-radius:0}.schedule-table{-webkit-transform:translateZ(0);transform:translateZ(0)}}@media only screen and (device-width:390px) and (device-height:844px) and (-webkit-device-pixel-ratio:3){.container{padding:15px}.client-item{padding:18px 12px}.btn-primary,.btn-secondary{font-size:15px;padding:14px 24px}}.payment-type-selector{display:flex;gap:10px;margin-bottom:20px}.payment-type-btn{flex:1;padding:15px;border:2px solid #e0e0e0;background:#f8f9fa;border-radius:10px;cursor:pointer;text-align:center;transition:all 0.2s;-webkit-appearance:none;appearance:none}.payment-type-btn:hover{background:#f0f0f0}.payment-type-btn.active{background:#667eea;color:white;border-color:#667eea}.payment-type-btn .icon{font-size:24px;margin-bottom:5px}.payment-type-btn .label{font-size:14px;font-weight:500}.payment-inputs{transition:all 0.3s ease}.debt-badge{background:#dc3545;color:white;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600;margin-left:8px}.btn-morosidad{background:#dc3545;color:white;border:none;padding:15px 30px;border-radius:10px;font-size:16px;font-weight:600;width:100%;cursor:pointer;transition:transform 0.2s;margin-bottom:15px;-webkit-appearance:none;appearance:none}.btn-morosidad:active{transform:scale(0.98);opacity:0.9}.debt-clients-container{background:#fff5f5;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(220,53,69,0.1);border:1px solid #f8d7da}.debt-clients-container .client-item{margin-bottom:10px;}.debt-indicator{display:inline-block;width:8px;height:8px;background:#dc3545;border-radius:50%;margin-right:5px;animation:pulse 2s infinite}.morosidad-modal .modal-content{max-width:900px}.morosidad-table{width:100%;border-collapse:collapse;margin-top:20px}.morosidad-table th,.morosidad-table td{padding:12px;border:1px solid #e0e0e0;text-align:left}.morosidad-table th{background:#dc3545;color:white;font-weight:600}.morosidad-table tr:nth-child(even){background:#f8f9fa}.morosidad-table tr:hover{background:#fff5f5}.morosidad-stats{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}.morosidad-stat{background:#f8f9fa;padding:15px;border-radius:8px;text-align:center}.morosidad-stat-value{font-size:24px;font-weight:bold;color:#dc3545}.morosidad-stat-label{font-size:14px;color:#666;margin-top:5px}</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="header"><h1>Sistema de Pagos Andreli</h1></div>
<div class="container">
<div class="date-filter"><div><label for="dateFilter" class="form-label">Fecha:</label><input type="date" id="dateFilter" class="form-input" style="width:auto;"></div><div style="display:flex;gap:10px;"><button class="btn-secondary" onclick="setToday()">Hoy</button><button class="btn-secondary" onclick="document.getElementById('excelUpload').click()">📊 Excel</button><input type="file" id="excelUpload" accept=".xlsx,.xls" style="display:none;" onchange="handleExcelUpload(event)"></div></div>
<div class="stats-card"><h2 class="section-title">Resumen del Día</h2><div class="stats-grid"><div class="stat-item"><div class="stat-value" id="totalPaid">S/0.00</div><div class="stat-label">Total Recibido</div></div><div class="stat-item"><div class="stat-value" id="clientsPaid">0</div><div class="stat-label">Socios que Pagaron</div></div><div class="stat-item"><div class="stat-value" id="totalCash">S/0.00</div><div class="stat-label">💵 Efectivo</div></div><div class="stat-item"><div class="stat-value" id="totalYape">S/0.00</div><div class="stat-label">📱 Yape</div></div></div></div>
<div class="general-search-container"><h2 class="section-title">Buscar Socio</h2><div class="search-container"><input type="text" class="form-input search-input" id="generalClientSearch" placeholder="🔍 Buscar por nombre, ID o teléfono..." onkeyup="searchAllClients()"></div><div id="searchResults" class="search-results" style="display:none;"></div></div>
<button class="btn-primary" onclick="showAddClientModal()">➕ Agregar Socio</button>
<button class="btn-primary" onclick="showAddPaymentModal()">💰 Registrar Pago</button>
<button class="btn-morosidad" onclick="showMorosidadModal()">⚠️ Ver Morosidad</button>
<div class="client-list debt-clients-container" id="debtClientsSection" style="display:none;"><h2 class="section-title"><span class="debt-indicator"></span>Socios en Mora</h2><div class="clients-container" id="debtClientsContainer"><div id="debtClientsList"><div class="empty-state">No hay socios en mora</div></div></div></div>
<div class="client-list"><h2 class="section-title">Socios del Día</h2><div class="clients-container" id="clientsContainer"><div id="clientsList"><div class="empty-state">No hay socios registrados</div></div></div></div>
<div class="payment-history"><h2 class="section-title">Pagos del Día</h2><div class="payments-container" id="paymentsContainer"><div id="paymentsList"><div class="empty-state">No hay pagos registrados</div></div></div></div>
</div>
<div id="addClientModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Agregar Socio</h3><button class="close-btn" onclick="closeModal('addClientModal')">&times;</button></div><form onsubmit="addClient(event)"><div class="form-group"><label class="form-label">ID del Socio</label><input type="text" class="form-input" id="clientId" required></div><div class="form-group"><label class="form-label">Nombre del Socio</label><input type="text" class="form-input" id="clientName" required></div><div class="form-group"><label class="form-label">Teléfono (opcional)</label><input type="tel" class="form-input" id="clientPhone"></div><div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="clientDisbursementDate" required></div><div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="clientFrequency" required><option value="">Seleccionar frecuencia...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div><div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="clientQuota" step="0.01" required></div><div class="form-group"><label class="form-label">Plazo (número de cuotas)</label><input type="number" class="form-input" id="clientTerm" min="1" required></div><button type="submit" class="btn-primary">Agregar Socio</button></form></div></div>
<div id="editClientModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Modificar Socio</h3><button class="close-btn" onclick="closeModal('editClientModal')">&times;</button></div><form onsubmit="updateClient(event)"><input type="hidden" id="editClientId"><div class="form-group"><label class="form-label">Nombre del Socio</label><input type="text" class="form-input" id="editClientName" required></div><div class="form-group"><label class="form-label">Teléfono (opcional)</label><input type="tel" class="form-input" id="editClientPhone"></div><div class="form-group"><label class="form-label">Fecha de Desembolso</label><input type="date" class="form-input" id="editClientDisbursementDate" required></div><div class="form-group"><label class="form-label">Frecuencia de Pago</label><select class="form-input" id="editClientFrequency" required><option value="">Seleccionar frecuencia...</option><option value="DIARIO">Diario</option><option value="SEMANAL">Semanal</option><option value="QUINCENAL">Quincenal</option><option value="MENSUAL">Mensual</option></select></div><div class="form-group"><label class="form-label">Monto de Cuota</label><input type="number" class="form-input" id="editClientQuota" step="0.01" required></div><div class="form-group"><label class="form-label">Plazo (número de cuotas)</label><input type="number" class="form-input" id="editClientTerm" min="1" required></div><button type="submit" class="btn-primary">Guardar Cambios</button></form></div></div>
<div id="addPaymentModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Registrar Pago</h3><button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button></div><form onsubmit="addPayment(event)"><div class="form-group"><label class="form-label">Socio</label><input type="text" class="form-input" id="clientSearchModal" placeholder="🔍 Buscar y seleccionar socio..." autocomplete="off" onkeyup="filterModalClients()" onfocus="showClientDropdown()" required><input type="hidden" id="selectedClientId" required><div id="clientDropdown" class="client-dropdown" style="display:none;"></div></div><div class="form-group"><label class="form-label">Tipo de Pago</label><div class="payment-type-selector"><div class="payment-type-btn" onclick="selectPaymentType('efectivo')"><div class="icon">💵</div><div class="label">Efectivo</div></div><div class="payment-type-btn" onclick="selectPaymentType('yape')"><div class="icon">📱</div><div class="label">Yape</div></div><div class="payment-type-btn" onclick="selectPaymentType('parcial')"><div class="icon">💰</div><div class="label">Pago Parcial</div></div></div></div><div id="paymentInputsContainer" style="display:none;"><div class="payment-inputs" id="singlePaymentInputs" style="display:none;"><div class="form-group"><label class="form-label" id="singlePaymentLabel">Monto</label><input type="number" class="form-input" id="paymentAmountSingle" step="0.01" min="0"></div></div><div class="payment-inputs" id="partialPaymentInputs" style="display:none;"><div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;"><div class="form-group" style="margin-bottom:15px;"><label class="form-label">💵 Monto en Efectivo</label><input type="number" class="form-input" id="paymentAmountCash" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div><div class="form-group" style="margin-bottom:15px;"><label class="form-label">📱 Monto en Yape</label><input type="number" class="form-input" id="paymentAmountYape" step="0.01" value="0" min="0" onkeyup="updatePaymentTotal()" onchange="updatePaymentTotal()"></div><div style="border-top:2px solid #dee2e6;padding-top:10px;margin-top:10px;"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:600;font-size:16px;">Total:</span><span id="paymentTotal" style="font-size:20px;font-weight:bold;color:#667eea;">S/0.00</span></div></div></div></div></div><div class="form-group"><label class="form-label">Nota (opcional)</label><input type="text" class="form-input" id="paymentNote"></div><button type="submit" class="btn-primary">Registrar Pago</button></form></div></div>
<div id="clientDetailsModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Detalles del Socio</h3><button class="close-btn" onclick="closeModal('clientDetailsModal')">&times;</button></div><div id="clientDetailsContent"></div></div></div>
<div id="scheduleModal" class="modal"><div class="modal-content" style="max-width:800px;"><div class="modal-header"><h3 class="modal-title">Cronograma de Pagos</h3><button class="close-btn" onclick="closeModal('scheduleModal')">&times;</button></div><div id="scheduleModalContent"></div></div></div>
<div id="movementsModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Movimientos del Socio</h3><button class="close-btn" onclick="closeModal('movementsModal')">&times;</button></div><div id="movementsModalContent"></div></div></div>
<div id="morosidadModal" class="modal morosidad-modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Reporte de Morosidad</h3><button class="close-btn" onclick="closeModal('morosidadModal')">&times;</button></div><div id="morosidadModalContent"></div></div></div>
<script>
let clients=[];let payments=[];let scrollPosition=0;let selectedPaymentType='';
function getPeruvianDate(date=new Date()){const peruTime=new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"}));return peruTime;}
function getPeruvianDateString(date=new Date()){const options={timeZone:'America/Lima',year:'numeric',month:'2-digit',day:'2-digit'};const peruDateStr=date.toLocaleDateString('en-CA',options);return peruDateStr;}
function getPeruvianISOString(date=new Date()){return new Date(date.toLocaleString("en-US",{timeZone:"America/Lima"})).toISOString();}
function formatPeruvianTime(dateString){const date=new Date(dateString);return date.toLocaleTimeString('es-PE',{timeZone:'America/Lima',hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function formatPeruvianDate(dateString){const[year,month,day]=dateString.split('-');return`${day}/${month}/${year}`;}
function formatNumber(num){if(typeof num!=='number'||isNaN(num))return'0.00';return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function formatInteger(num){if(typeof num!=='number'||isNaN(num))return'0';return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',');}
function openWhatsApp(phone){if(!phone||phone.trim()===''){alert('Este socio no tiene número de teléfono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const whatsappUrl=`https://wa.me/${cleanPhone.replace('+','')}`;window.open(whatsappUrl,'_blank');}
function makeCall(phone){if(!phone||phone.trim()===''){alert('Este socio no tiene número de teléfono registrado');return;}let cleanPhone=phone.replace(/\s+/g,'').replace(/[-()]/g,'');if(!cleanPhone.startsWith('+51')&&!cleanPhone.startsWith('51')){cleanPhone='+51'+cleanPhone;}else if(cleanPhone.startsWith('51')&&!cleanPhone.startsWith('+51')){cleanPhone='+'+cleanPhone;}const callUrl=`tel:${cleanPhone}`;window.location.href=callUrl;}
function formatExcelDate(excelDate){if(!excelDate)return'';if(excelDate instanceof Date){const year=excelDate.getFullYear();const month=(excelDate.getMonth()+1).toString().padStart(2,'0');const day=excelDate.getDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}if(typeof excelDate==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(excelDate)){return excelDate;}if(typeof excelDate==='string'){excelDate=excelDate.trim();if(excelDate.includes('/')||excelDate.includes('-')){const parts=excelDate.split(/[/-]/);if(parts.length===3){let day,month,year;if(parts[0].length===4){year=parts[0];month=parts[1].padStart(2,'0');day=parts[2].padStart(2,'0');}else{day=parts[0].padStart(2,'0');month=parts[1].padStart(2,'0');if(parts[2].length===2){const currentYear=new Date().getFullYear();const century=Math.floor(currentYear/100)*100;const yearNum=parseInt(parts[2]);if(yearNum<=currentYear%100){year=century+yearNum;}else{year=(century-100)+yearNum;}}else{year=parts[2];}}const dateObj=new Date(parseInt(year),parseInt(month)-1,parseInt(day));if(!isNaN(dateObj.getTime())){return`${year}-${month}-${day}`;}}}}else if(typeof excelDate==='number'){const utcDays=Math.floor(excelDate-25569);const utcValue=utcDays*86400;const dateInfo=new Date(utcValue*1000);const year=dateInfo.getUTCFullYear();if(year<2020||year>2030){console.warn('Fecha fuera de rango:',year);return'';}const month=(dateInfo.getUTCMonth()+1).toString().padStart(2,'0');const day=dateInfo.getUTCDate().toString().padStart(2,'0');return`${year}-${month}-${day}`;}return'';}
function parseExcelNumber(value){if(typeof value==='number')return value;if(typeof value==='string'){value=value.trim();value=value.replace(/,/g,'');value=value.replace(/\s/g,'');value=value.replace('S/.','');value=value.replace('S/','');const num=parseFloat(value);return isNaN(num)?0:num;}return 0;}
function mapFrequency(freq){if(!freq)return'';const upperFreq=freq.toString().toUpperCase().trim();const mappings={'DIAR':'DIARIO','SEMA':'SEMANAL','QUIN':'QUINCENAL','MENS':'MENSUAL','DIARIO':'DIARIO','DIARIA':'DIARIO','SEMANAL':'SEMANAL','QUINCENAL':'QUINCENAL','MENSUAL':'MENSUAL','D':'DIARIO','S':'SEMANAL','Q':'QUINCENAL','M':'MENSUAL'};if(mappings[upperFreq]){return mappings[upperFreq];}if(upperFreq.includes('DIAR'))return'DIARIO';if(upperFreq.includes('SEMA'))return'SEMANAL';if(upperFreq.includes('QUIN'))return'QUINCENAL';if(upperFreq.includes('MENS'))return'MENSUAL';console.warn('Frecuencia no reconocida:',freq);return'';}
function handleExcelUpload(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=function(e){try{const fileContent=e.target.result;let data=[];let columnMap={};const isHtmlContent=typeof fileContent==='string'&&(fileContent.includes('<table')||fileContent.includes('<TABLE')||fileContent.includes('<tr')||fileContent.includes('<TR'));if(isHtmlContent){const htmlContent=fileContent;const rowMatches=htmlContent.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi)||[];function extractCellContent(rowHtml){const cellMatches=rowHtml.match(/<t[hd][^>]*>([^<]*)<\/t[hd]>/gi)||[];return cellMatches.map(cell=>{const content=cell.replace(/<[^>]+>/g,'').trim();return content;});}let headerRowIndex=-1;let headers=[];for(let i=0;i<rowMatches.length;i++){const cells=extractCellContent(rowMatches[i]);if(cells.some(cell=>cell==='Id'||cell==='Nombre')){headerRowIndex=i;headers=cells;break;}}if(headerRowIndex===-1){alert('No se encontraron las columnas esperadas en el archivo');return;}columnMap={id:headers.indexOf('Id'),nombre:headers.indexOf('Nombre'),telefono:headers.findIndex(h=>h.includes('Tel')),fechaDesem:headers.findIndex(h=>h.includes('Fecha Desem')),monto:headers.indexOf('Monto'),plz:headers.indexOf('Plz'),frecPago:headers.findIndex(h=>h.includes('Frec Pago')),montoCuota:headers.findIndex(h=>h.includes('Monto Cuota')),mora:headers.indexOf('Mora'),totalAtraso:headers.findIndex(h=>h.includes('Total Atraso')),diaAtr:headers.findIndex(h=>h.includes('Dia Atr'))};console.log('Mapeo de columnas:',columnMap);for(let i=headerRowIndex+1;i<rowMatches.length;i++){const cells=extractCellContent(rowMatches[i]);if(cells.length>columnMap.id&&cells[columnMap.id]){data.push(cells);}}}else{const workbook=XLSX.read(new Uint8Array(fileContent),{type:'array',cellDates:false,raw:true});const firstSheet=workbook.Sheets[workbook.SheetNames[0]];const jsonData=XLSX.utils.sheet_to_json(firstSheet,{header:1,raw:true});if(jsonData.length<2){alert('El archivo Excel está vacío o no tiene el formato correcto');return;}data=jsonData.slice(1);columnMap={id:0,nombre:1,telefono:2,fechaDesem:3,monto:4,plz:5,frecPago:6,montoCuota:7,mora:8,totalAtraso:9,diaAtr:10};}let updatedCount=0;let addedCount=0;let errorCount=0;const errors=[];for(let i=0;i<data.length;i++){const row=data[i];if(!row[columnMap.id]||!row[columnMap.nombre])continue;try{const id=row[columnMap.id].toString().trim();const name=row[columnMap.nombre].toString().trim();const phone=row[columnMap.telefono]?row[columnMap.telefono].toString().trim():'';const disbursementDate=row[columnMap.fechaDesem]?formatExcelDate(row[columnMap.fechaDesem]):'';const monto=row[columnMap.monto]?parseExcelNumber(row[columnMap.monto]):0;const term=row[columnMap.plz]?parseInt(row[columnMap.plz]):0;const frequency=row[columnMap.frecPago]?mapFrequency(row[columnMap.frecPago].toString().trim()):'';const quota=row[columnMap.montoCuota]?parseExcelNumber(row[columnMap.montoCuota]):0;const mora=row[columnMap.mora]?parseExcelNumber(row[columnMap.mora]):0;const totalAtraso=row[columnMap.totalAtraso]?parseExcelNumber(row[columnMap.totalAtraso]):0;const diasAtraso=row[columnMap.diaAtr]?parseInt(row[columnMap.diaAtr]):0;if(!disbursementDate){errors.push(`Fila ${i+1}: Fecha de desembolso inválida para ${name}`);errorCount++;continue;}if(!term||term<=0){errors.push(`Fila ${i+1}: Plazo inválido para ${name}`);errorCount++;continue;}if(!frequency){errors.push(`Fila ${i+1}: Frecuencia inválida para ${name} (valor original: "${row[columnMap.frecPago]||'vacío'}")`);errorCount++;continue;}if(!quota||quota<=0){errors.push(`Fila ${i+1}: Monto de cuota inválido para ${name}`);errorCount++;continue;}const existingClient=clients.find(c=>c.id===id);if(existingClient){existingClient.name=name;existingClient.phone=phone;existingClient.disbursementDate=disbursementDate;existingClient.term=term;existingClient.frequency=frequency;existingClient.quota=quota;existingClient.monto=monto;existingClient.mora=mora;existingClient.totalAtraso=totalAtraso;existingClient.diasAtraso=diasAtraso;updatedCount++;console.log('Socio actualizado:',existingClient);}else{const newClient={id:id,name:name,phone:phone,disbursementDate:disbursementDate,frequency:frequency,quota:quota,term:term,monto:monto,mora:mora,totalAtraso:totalAtraso,diasAtraso:diasAtraso,createdAt:getPeruvianISOString()};clients.push(newClient);addedCount++;console.log('Socio agregado:',newClient);}}catch(err){errors.push(`Fila ${i+1}: Error al procesar - ${err.message}`);errorCount++;}}saveData();updateDisplay();let message=`Archivo procesado:\n- Socios nuevos: ${addedCount}\n- Socios actualizados: ${updatedCount}`;const morosidadCount=clients.filter(c=>c.diasAtraso>0).length;message+=`\n- Socios en mora: ${morosidadCount}`;if(errorCount>0){message+=`\n- Errores: ${errorCount}\n\nDetalles de errores:\n${errors.slice(0,5).join('\n')}`;if(errors.length>5){message+=`\n... y ${errors.length-5} errores más`;}}alert(message);event.target.value='';}catch(error){alert('Error al procesar el archivo. Asegúrate de que sea un archivo Excel válido.\n\nError: '+error.message);console.error('Error completo:',error);event.target.value='';}};if(file.name.toLowerCase().endsWith('.xls')){reader.readAsText(file,'utf-8');}else{reader.readAsArrayBuffer(file);}}
const excelClients=[];
function init(){loadData();importExcelClients();setToday();updateDisplay();document.addEventListener('click',function(e){if(!e.target.closest('.form-group')){hideClientDropdown();}});}
function importExcelClients(){localStorage.removeItem('excelClientsImported');localStorage.removeItem('excelClientsImported_v2');localStorage.removeItem('excelClientsImported_v3');localStorage.removeItem('excelClientsImported_v4');localStorage.removeItem('excelClientsImported_v5');localStorage.removeItem('excelClientsImported_v6');localStorage.removeItem('excelClientsImported_v7');localStorage.removeItem('excelClientsImported_v8');localStorage.removeItem('excelClientsImported_v9');localStorage.removeItem('excelClientsImported_v10');const savedImport=localStorage.getItem('excelClientsImported_v11');if(!savedImport){excelClients.forEach(excelClient=>{const existingClient=clients.find(c=>c.id===excelClient.id);if(existingClient){existingClient.quota=excelClient.quota;existingClient.term=excelClient.term;existingClient.disbursementDate=excelClient.disbursementDate;existingClient.frequency=excelClient.frequency;existingClient.phone=excelClient.phone;existingClient.name=excelClient.name;}else{clients.push({id:excelClient.id,name:excelClient.name,phone:excelClient.phone,disbursementDate:excelClient.disbursementDate,frequency:excelClient.frequency,quota:excelClient.quota,term:excelClient.term,createdAt:getPeruvianISOString()});}});localStorage.setItem('excelClientsImported_v11','true');saveData();}}
function searchAllClients(){const searchTerm=document.getElementById('generalClientSearch').value.toLowerCase();const resultsContainer=document.getElementById('searchResults');if(searchTerm===''){resultsContainer.style.display='none';return;}const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||client.id.includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));resultsContainer.style.display='block';if(filteredClients.length===0){resultsContainer.innerHTML='<div class="no-results">No se encontraron socios</div>';}else{resultsContainer.innerHTML=filteredClients.map(client=>`<div class="search-result-item" onclick="showClientDetailsModal('${client.id}')"><div style="font-size:11px;color:#999;">ID:${client.id}</div><div style="font-weight:600;">${client.name}</div>${client.phone?`<div style="font-size:13px;color:#666;">${client.phone}</div>`:''}</div>`).join('');}}
function showClientDetailsModal(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const today=getPeruvianDate();const nextPaymentInfo=getNextPaymentDate(client);const clientPayments=payments.filter(p=>p.clientId===clientId);const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const totalDeuda=client.quota?(client.quota*client.term)-totalPaid:0;const content=document.getElementById('clientDetailsContent');content.innerHTML=`<div class="client-detail-info"><div class="detail-row"><span class="detail-label">ID:</span><span class="detail-value">${client.id}</span></div><div class="detail-row"><span class="detail-label">Nombre:</span><span class="detail-value">${client.name}</span></div><div class="detail-row"><span class="detail-label">Teléfono:</span><span class="detail-value">${client.phone||'No registrado'}</span></div><div class="detail-row"><span class="detail-label">Fecha de desembolso:</span><span class="detail-value">${client.disbursementDate?formatPeruvianDate(client.disbursementDate):'N/A'}</span></div><div class="detail-row"><span class="detail-label">Frecuencia:</span><span class="detail-value">${client.frequency||'N/A'}</span></div><div class="detail-row"><span class="detail-label">Cuota:</span><span class="detail-value" style="color:#1a5490;">S/${client.quota?formatNumber(client.quota):'0.00'}</span></div><div class="detail-row"><span class="detail-label">Plazo:</span><span class="detail-value">${client.term?formatInteger(client.term):'N/A'} cuotas</span></div>${client.diasAtraso>0?`<div class="detail-row"><span class="detail-label">Días de atraso:</span><span class="detail-value" style="color:#dc3545;">${client.diasAtraso} días</span></div><div class="detail-row"><span class="detail-label">Mora:</span><span class="detail-value" style="color:#dc3545;">S/${formatNumber(client.mora||0)}</span></div><div class="detail-row"><span class="detail-label">Total atraso:</span><span class="detail-value" style="color:#dc3545;">S/${formatNumber(client.totalAtraso||0)}</span></div>`:''}<div class="detail-row"><span class="detail-label">Próximo pago:</span><span class="detail-value">${nextPaymentInfo}</span></div><div class="detail-row"><span class="detail-label">Total pagado:</span><span class="detail-value" style="color:#28a745;">S/${formatNumber(totalPaid)}</span></div><div class="detail-row"><span class="detail-label">Total deuda:</span><span class="detail-value" style="color:#dc3545;">S/${formatNumber(totalDeuda)}</span></div><div class="detail-row"><span class="detail-label">Número de pagos:</span><span class="detail-value">${formatInteger(clientPayments.length)}</span></div></div><div class="action-buttons"><button class="btn-action btn-schedule" onclick="showPaymentSchedule('${client.id}')">📅 Crono</button><button class="btn-action btn-movements" onclick="showClientMovements('${client.id}')">📊 Mov.</button>${client.phone?`<button class="btn-action btn-call" onclick="makeCall('${client.phone}')">📞 Llamar</button><button class="btn-action btn-whatsapp" onclick="openWhatsApp('${client.phone}')">📱 WhatsApp</button>`:''}<button class="btn-action btn-edit-client" onclick="showEditClientModal('${client.id}');closeModal('clientDetailsModal');">✏️ Modificar</button><button class="btn-action btn-delete-client" onclick="deleteClientFromDetails('${client.id}')">🗑️ Eliminar</button></div>`;showModal('clientDetailsModal');}
function showClientMovements(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const clientPayments=payments.filter(p=>p.clientId===clientId).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));let movementsHTML=`<div style="margin-bottom:20px;"><h4 style="margin:0;">${client.name}</h4><p style="margin:5px 0;color:#666;">ID: ${client.id}</p></div>`;if(clientPayments.length===0){movementsHTML+=`<div class="empty-state">No hay movimientos registrados para este socio</div>`;}else{movementsHTML+=`<div class="movements-list">`;clientPayments.forEach(payment=>{const methodIcon=payment.method==='yape'?'📱':'💵';const methodText=payment.method==='yape'?'Yape':'Efectivo';movementsHTML+=`<div class="movement-item"><div class="movement-date">${formatPeruvianDate(payment.date)}</div><div class="movement-details"><div><span class="movement-method">${methodIcon} ${methodText}</span>${payment.note?`<div style="font-size:12px;color:#999;margin-top:3px;">${payment.note}</div>`:''}</div><div class="movement-amount">S/${formatNumber(payment.amount)}</div></div><div style="font-size:11px;color:#999;margin-top:5px;">${formatPeruvianTime(payment.timestamp)}</div></div>`;});movementsHTML+=`</div>`;const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);movementsHTML+=`<div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;"><div style="display:flex;justify-content:space-between;"><strong>Total de movimientos:</strong><span style="color:#28a745;font-weight:bold;">S/${formatNumber(totalPaid)}</span></div></div>`;}document.getElementById('movementsModalContent').innerHTML=movementsHTML;showModal('movementsModal');}
function deleteClientFromDetails(clientId){if(confirm('¿Estás seguro de eliminar este socio? Se mantendrán los pagos históricos.')){clients=clients.filter(c=>c.id!==clientId);saveData();updateDisplay();closeModal('clientDetailsModal');}}
function getNextPaymentDate(client){if(!client.disbursementDate){return'N/A';}const today=getPeruvianDateString();const todayParts=today.split('-');const todayDate=new Date(parseInt(todayParts[0]),parseInt(todayParts[1])-1,parseInt(todayParts[2]));for(let i=1;i<=60;i++){const checkDate=new Date(todayDate);checkDate.setDate(checkDate.getDate()+i);const checkDateStr=`${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2,'0')}-${String(checkDate.getDate()).padStart(2,'0')}`;if(shouldPayOnDate(client,checkDateStr)){return`${String(checkDate.getDate()).padStart(2,'0')}/${String(checkDate.getMonth()+1).padStart(2,'0')}/${checkDate.getFullYear()}`;}}return'N/A';}
function shouldPayOnDate(client,checkDate){if(!client.disbursementDate||!client.frequency){return false;}const[disbYear,disbMonth,disbDay]=client.disbursementDate.split('-').map(n=>parseInt(n));const[checkYear,checkMonth,checkDay]=checkDate.split('-').map(n=>parseInt(n));if(isNaN(disbYear)||isNaN(disbMonth)||isNaN(disbDay)||isNaN(checkYear)||isNaN(checkMonth)||isNaN(checkDay)){console.warn('Fecha inválida en shouldPayOnDate:',client.disbursementDate,checkDate);return false;}const disbursementDate=new Date(disbYear,disbMonth-1,disbDay);const targetDate=new Date(checkYear,checkMonth-1,checkDay);if(targetDate<=disbursementDate){return false;}const daysDiff=Math.floor((targetDate-disbursementDate)/(1000*60*60*24));const dayOfWeek=targetDate.getDay();switch(client.frequency){case'DIARIO':return dayOfWeek>=1&&dayOfWeek<=5&&daysDiff>=1;case'SEMANAL':return daysDiff>0&&daysDiff%7===0;case'QUINCENAL':return daysDiff>0&&daysDiff%15===0;case'MENSUAL':if(daysDiff<28)return false;const monthsDiff=(checkYear-disbYear)*12+(checkMonth-disbMonth);if(monthsDiff<1)return false;if(checkDay===disbDay){return true;}const lastDayOfTargetMonth=new Date(checkYear,checkMonth,0).getDate();if(checkDay===lastDayOfTargetMonth&&disbDay>lastDayOfTargetMonth){return true;}if(disbDay>28&&checkDay===lastDayOfTargetMonth){return true;}return false;default:console.warn('Frecuencia no reconocida:',client.frequency);return false;}}
function loadData(){const savedClients=localStorage.getItem('clients');const savedPayments=localStorage.getItem('payments');if(savedClients)clients=JSON.parse(savedClients);if(savedPayments)payments=JSON.parse(savedPayments);}
function saveData(){localStorage.setItem('clients',JSON.stringify(clients));localStorage.setItem('payments',JSON.stringify(payments));}
function setToday(){const today=getPeruvianDateString();document.getElementById('dateFilter').value=today;updateDisplay();}
function updateDisplay(){const selectedDate=document.getElementById('dateFilter').value;updateStats(selectedDate);updateDebtClients();updateClientsList(selectedDate);updatePaymentsList(selectedDate);}
function updateDebtClients(){const debtClients=clients.filter(c=>c.diasAtraso>0);const debtSection=document.getElementById('debtClientsSection');const debtList=document.getElementById('debtClientsList');if(debtClients.length===0){debtSection.style.display='none';return;}debtSection.style.display='block';debtList.innerHTML=debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).map(client=>{return`<div class="client-item in-debt" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;"><div style="font-weight:600;font-size:16px;color:#333;margin-bottom:8px;">${client.name}</div><div style="display:flex;align-items:center;gap:12px;margin-bottom:5px;flex-wrap:wrap;"><span class="client-status status-overdue">${client.diasAtraso} días atraso</span><span class="debt-badge">Mora: S/${formatNumber(client.mora||0)}</span><span style="background:#dc3545;color:white;padding:2px 8px;border-radius:6px;font-size:12px;font-weight:600;">Total: S/${formatNumber(client.totalAtraso||0)}</span></div></div><button class="btn-circle btn-pay" onclick="quickPaymentDebt('${client.id}');event.stopPropagation();" title="Pago rápido">💰</button></div>`;}).join('');}
function updateStats(date){const dayPayments=payments.filter(p=>p.date===date);const total=dayPayments.reduce((sum,p)=>sum+p.amount,0);const uniqueClients=new Set(dayPayments.map(p=>p.clientId)).size;const cashTotal=dayPayments.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeTotal=dayPayments.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);document.getElementById('totalPaid').textContent=`S/${formatNumber(total)}`;document.getElementById('clientsPaid').textContent=formatInteger(uniqueClients);document.getElementById('totalCash').textContent=`S/${formatNumber(cashTotal)}`;document.getElementById('totalYape').textContent=`S/${formatNumber(yapeTotal)}`;}
function updateClientsList(date){const clientsList=document.getElementById('clientsList');const dayPayments=payments.filter(p=>p.date===date);const clientsToPayToday=clients.filter(client=>shouldPayOnDate(client,date));if(clientsToPayToday.length===0){clientsList.innerHTML='<div class="empty-state">No hay socios que deban pagar hoy</div>';return;}clientsList.innerHTML=clientsToPayToday.map(client=>{const clientPayments=dayPayments.filter(p=>p.clientId===client.id);const hasPaid=clientPayments.length>0;const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const freqClass={'DIARIO':'freq-diario','SEMANAL':'freq-semanal','QUINCENAL':'freq-quincenal','MENSUAL':'freq-mensual'}[client.frequency];const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;return`<div class="client-item ${client.diasAtraso>0?'in-debt':''}" onclick="showClientDetailsModal('${client.id}')"><div style="flex:1;"><div style="font-weight:600;font-size:16px;color:#333;margin-bottom:8px;">${client.name}</div><div style="display:flex;align-items:center;gap:12px;margin-bottom:5px;"><span class="client-status ${hasPaid?'status-paid':'status-pending'}">${hasPaid?'Pagó':'Pendiente'}</span><span class="frequency-badge ${freqClass}" style="text-transform:uppercase;font-size:11px;">${client.frequency}</span>${displayQuota?`<span class="client-quota" style="font-size:14px;">S/${formatNumber(displayQuota)}</span>`:''}</div>${hasPaid?`<div style="font-size:12px;color:#666;">Pagó:S/${formatNumber(totalPaid)}</div>`:''}</div><button class="btn-circle btn-pay" onclick="quickPayment('${client.id}');event.stopPropagation();" title="Pago rápido">💰</button></div>`;}).join('');}
function selectPaymentType(type){selectedPaymentType=type;const buttons=document.querySelectorAll('.payment-type-btn');buttons.forEach(btn=>btn.classList.remove('active'));event.target.closest('.payment-type-btn').classList.add('active');document.getElementById('paymentInputsContainer').style.display='block';if(type==='parcial'){document.getElementById('singlePaymentInputs').style.display='none';document.getElementById('partialPaymentInputs').style.display='block';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();}else{document.getElementById('partialPaymentInputs').style.display='none';document.getElementById('singlePaymentInputs').style.display='block';const label=type==='efectivo'?'💵 Monto en Efectivo':'📱 Monto en Yape';document.getElementById('singlePaymentLabel').textContent=label;document.getElementById('paymentAmountSingle').value='';}}
function updatePaymentTotal(){const cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;const yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;const total=cashAmount+yapeAmount;document.getElementById('paymentTotal').textContent=`S/${formatNumber(total)}`;}
function updatePaymentsList(date){const paymentsList=document.getElementById('paymentsList');const dayPayments=payments.filter(p=>p.date===date);if(dayPayments.length===0){paymentsList.innerHTML='<div class="empty-state">No hay pagos registrados</div>';return;}const groupedPayments={};dayPayments.forEach(payment=>{if(!groupedPayments[payment.timestamp]){groupedPayments[payment.timestamp]=[];}groupedPayments[payment.timestamp].push(payment);});const sortedGroups=Object.entries(groupedPayments).sort((a,b)=>new Date(b[0])-new Date(a[0]));paymentsList.innerHTML=sortedGroups.map(([timestamp,paymentGroup])=>{const client=clients.find(c=>c.id===paymentGroup[0].clientId);const totalAmount=paymentGroup.reduce((sum,p)=>sum+p.amount,0);const hasCash=paymentGroup.some(p=>p.method==='efectivo');const hasYape=paymentGroup.some(p=>p.method==='yape');const isMixed=hasCash&&hasYape;let methodDisplay='';if(isMixed){const cashAmount=paymentGroup.filter(p=>p.method==='efectivo').reduce((sum,p)=>sum+p.amount,0);const yapeAmount=paymentGroup.filter(p=>p.method==='yape').reduce((sum,p)=>sum+p.amount,0);methodDisplay=`<span class="payment-method method-mixto">💰 Mixto</span><div style="font-size:11px;color:#666;margin-top:3px;">💵 S/${formatNumber(cashAmount)} | 📱 S/${formatNumber(yapeAmount)}</div>`;}else{const payment=paymentGroup[0];const methodIcon=payment.method==='yape'?'📱':'💵';const methodClass=payment.method==='yape'?'method-yape':'method-efectivo';const methodText=payment.method==='yape'?'Yape':'Efectivo';methodDisplay=`<span class="payment-method ${methodClass}">${methodIcon} ${methodText}</span>`;}return`<div class="payment-item"><div class="payment-id">ID:${client?client.id:'N/A'}</div><div class="payment-client">${client?client.name:'Socio eliminado'}${methodDisplay}</div><div class="payment-details"><span>${paymentGroup[0].note||'Sin nota'}</span><span class="payment-amount">S/${formatNumber(totalAmount)}</span></div><div class="payment-details"><span>${formatPeruvianTime(paymentGroup[0].timestamp)}</span><button class="btn-danger" onclick="deletePaymentGroup('${timestamp}')">Eliminar</button></div></div>`;}).join('');}
function showClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='block';filterModalClients();}
function hideClientDropdown(){const dropdown=document.getElementById('clientDropdown');dropdown.style.display='none';}
function filterModalClients(){const searchTerm=document.getElementById('clientSearchModal').value.toLowerCase();const dropdown=document.getElementById('clientDropdown');const filteredClients=clients.filter(client=>client.name.toLowerCase().includes(searchTerm)||(client.phone&&client.phone.includes(searchTerm)));if(filteredClients.length===0){dropdown.innerHTML='<div class="no-results">No se encontraron socios</div>';}else{dropdown.innerHTML=filteredClients.map(client=>{const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;return`<div class="dropdown-item" onclick="selectClient('${client.id}','${client.name}',${displayQuota||0})"><div class="dropdown-item-name">${client.name}${client.diasAtraso>0?'<span class="debt-badge" style="margin-left:8px;font-size:10px;">En mora</span>':''}</div>${client.phone?`<div class="dropdown-item-phone">${client.phone}</div>`:''}</div>`;}).join('');}}
function selectClient(clientId,clientName,quota){document.getElementById('selectedClientId').value=clientId;document.getElementById('clientSearchModal').value=clientName;hideClientDropdown();if(selectedPaymentType&&selectedPaymentType!=='parcial'&&quota&&quota>0){document.getElementById('paymentAmountSingle').value=quota;}else if(selectedPaymentType==='parcial'&&quota&&quota>0){document.getElementById('paymentAmountCash').value=quota;document.getElementById('paymentAmountYape').value=0;updatePaymentTotal();}}
function showModal(modalId){const modal=document.getElementById(modalId);scrollPosition=window.pageYOffset||document.documentElement.scrollTop;modal.style.display='block';document.body.style.overflow='hidden';document.body.style.position='fixed';document.body.style.width='100%';document.body.style.top=`-${scrollPosition}px`;requestAnimationFrame(()=>{modal.classList.add('show');});}
function closeModal(modalId){const modal=document.getElementById(modalId);const modalContent=modal.querySelector('.modal-content');modalContent.classList.add('closing');modal.classList.remove('show');setTimeout(()=>{modal.style.display='none';modalContent.classList.remove('closing');document.body.style.overflow='';document.body.style.position='';document.body.style.width='';document.body.style.top='';window.scrollTo(0,scrollPosition);},300);if(modalId==='addPaymentModal'){document.getElementById('clientSearchModal').value='';document.getElementById('selectedClientId').value='';document.getElementById('paymentAmountSingle').value='';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';updatePaymentTotal();hideClientDropdown();selectedPaymentType='';document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('paymentInputsContainer').style.display='none';}}
function showAddClientModal(){document.getElementById('clientId').value='';document.getElementById('clientName').value='';document.getElementById('clientPhone').value='';document.getElementById('clientDisbursementDate').value='';document.getElementById('clientFrequency').value='';document.getElementById('clientQuota').value='';document.getElementById('clientTerm').value='';showModal('addClientModal');}
function showAddPaymentModal(){if(clients.length===0){alert('Primero debes agregar al menos un socio');return;}document.getElementById('clientSearchModal').value='';document.getElementById('selectedClientId').value='';document.getElementById('paymentAmountSingle').value='';document.getElementById('paymentAmountCash').value='0';document.getElementById('paymentAmountYape').value='0';document.getElementById('paymentNote').value='';updatePaymentTotal();selectedPaymentType='';document.querySelectorAll('.payment-type-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('paymentInputsContainer').style.display='none';showModal('addPaymentModal');}
function addClient(event){event.preventDefault();const id=document.getElementById('clientId').value.trim();const name=document.getElementById('clientName').value.trim();const phone=document.getElementById('clientPhone').value.trim();const disbursementDate=document.getElementById('clientDisbursementDate').value;const frequency=document.getElementById('clientFrequency').value;const quota=parseFloat(document.getElementById('clientQuota').value);const term=parseInt(document.getElementById('clientTerm').value);if(clients.find(c=>c.id===id)){alert('Ya existe un socio con ese ID');return;}const newClient={id:id,name:name,phone:phone,disbursementDate:disbursementDate,frequency:frequency,quota:quota,term:term,createdAt:getPeruvianISOString()};clients.push(newClient);saveData();updateDisplay();closeModal('addClientModal');}
function addPayment(event){event.preventDefault();const clientId=document.getElementById('selectedClientId').value;const note=document.getElementById('paymentNote').value.trim();const date=document.getElementById('dateFilter').value;if(!clientId){alert('Por favor selecciona un socio de la lista');return;}if(!selectedPaymentType){alert('Por favor selecciona un tipo de pago');return;}let cashAmount=0;let yapeAmount=0;if(selectedPaymentType==='efectivo'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto válido');return;}cashAmount=amount;}else if(selectedPaymentType==='yape'){const amount=parseFloat(document.getElementById('paymentAmountSingle').value)||0;if(amount<=0){alert('Por favor ingresa un monto válido');return;}yapeAmount=amount;}else if(selectedPaymentType==='parcial'){cashAmount=parseFloat(document.getElementById('paymentAmountCash').value)||0;yapeAmount=parseFloat(document.getElementById('paymentAmountYape').value)||0;if(cashAmount===0&&yapeAmount===0){alert('Por favor ingresa al menos un monto');return;}}const timestamp=getPeruvianISOString();if(cashAmount>0){const cashPayment={id:Date.now().toString()+'_cash',clientId:clientId,amount:cashAmount,method:'efectivo',note:note+(yapeAmount>0?' (Pago parcial - Efectivo)':''),date:date,timestamp:timestamp};payments.push(cashPayment);}if(yapeAmount>0){const yapePayment={id:Date.now().toString()+'_yape',clientId:clientId,amount:yapeAmount,method:'yape',note:note+(cashAmount>0?' (Pago parcial - Yape)':''),date:date,timestamp:timestamp};payments.push(yapePayment);}saveData();updateDisplay();closeModal('addPaymentModal');}
function deleteClient(clientId,event){event.stopPropagation();if(confirm('¿Estás seguro de eliminar este socio? Se mantendrán los pagos históricos.')){clients=clients.filter(c=>c.id!==clientId);saveData();updateDisplay();}}
function deletePayment(paymentId){if(confirm('¿Estás seguro de eliminar este pago?')){payments=payments.filter(p=>p.id!==paymentId);saveData();updateDisplay();}}
function deletePaymentGroup(timestamp){if(confirm('¿Estás seguro de eliminar este pago?')){payments=payments.filter(p=>p.timestamp!==timestamp);saveData();updateDisplay();}}
document.getElementById('dateFilter').addEventListener('change',updateDisplay);
window.onclick=function(event){if(event.target.classList.contains('modal')){const modalId=event.target.id;closeModal(modalId);}}
document.addEventListener('touchstart',function(e){if(e.touches.length>1){e.preventDefault();}});
if(window.navigator.standalone){document.addEventListener('click',function(e){if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||e.target.tagName==='SELECT'){e.target.focus();}});}
function showPaymentSchedule(clientId){const client=clients.find(c=>c.id===clientId);if(!client){alert('Socio no encontrado');return;}if(!client.disbursementDate){alert('Este socio no tiene fecha de desembolso registrada. Por favor, edita el socio y agrega esta información.');return;}if(!client.term||client.term<=0){alert('Este socio no tiene un plazo válido registrado. Por favor, edita el socio y agrega esta información.');return;}if(!client.frequency){alert('Este socio no tiene frecuencia de pago registrada. Por favor, edita el socio y agrega esta información.');return;}if(!client.quota||client.quota<=0){alert('Este socio no tiene monto de cuota válido. Por favor, edita el socio y agrega esta información.');return;}console.log('Generando cronograma para:',client);const clientPayments=payments.filter(p=>p.clientId===clientId);const paymentDates=[];const[year,month,day]=client.disbursementDate.split('-').map(n=>parseInt(n));const startDate=new Date(year,month-1,day);if(isNaN(startDate.getTime())){alert('La fecha de desembolso del socio no es válida. Por favor, verifica los datos.');return;}let currentDate=new Date(startDate);let paymentCount=0;const maxDays=client.frequency==='MENSUAL'?client.term*31:365;while(paymentCount<client.term&&currentDate<=new Date(startDate.getTime()+(maxDays*24*60*60*1000))){const dateStr=`${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(currentDate.getDate()).padStart(2,'0')}`;if(shouldPayOnDate(client,dateStr)){paymentDates.push(new Date(currentDate));paymentCount++;}currentDate.setDate(currentDate.getDate()+1);}if(paymentDates.length===0){alert('No se pudo generar el cronograma. Verifica que la frecuencia y fecha de desembolso sean correctas.');return;}let scheduleHTML=`<div style="margin-bottom:20px;"><h4 style="margin:0;">Socio:${client.name}</h4><p style="margin:5px 0;color:#666;">ID:${client.id}</p><p style="margin:5px 0;color:#666;">Frecuencia:${client.frequency} | Plazo:${formatInteger(client.term)} cuotas | Cuota:S/${formatNumber(client.quota)}</p></div><table class="schedule-table"><thead><tr><th>N°</th><th>F. Pago</th><th>Monto</th><th>Estado</th></tr></thead><tbody>`;const today=getPeruvianDateString();const totalPagadoReal=clientPayments.reduce((sum,p)=>sum+p.amount,0);let saldoDisponible=totalPagadoReal;paymentDates.forEach((date,index)=>{const dateStr=date.toISOString().split('T')[0];const formattedDate=formatPeruvianDate(dateStr);let statusIcon='';let statusClass='';if(saldoDisponible>=client.quota){statusIcon='<span class="check-icon">✓</span>';statusClass='paid';saldoDisponible-=client.quota;}else if(saldoDisponible>0){const porcentaje=Math.round((saldoDisponible/client.quota)*100);statusIcon=`<span class="partial-icon">${porcentaje}%</span>`;statusClass='partial';saldoDisponible=0;}else if(dateStr<today){statusIcon='<span style="color:#dc3545;">✗</span>';statusClass='pending';}else if(dateStr===today){statusIcon='<span style="color:#f39c12;">⏰</span>';statusClass='pending';}else{statusIcon='<span style="color:#999;">○</span>';statusClass='future';}scheduleHTML+=`<tr class="${statusClass}"><td>${index+1}</td><td>${formattedDate}</td><td>S/${formatNumber(client.quota)}</td><td style="text-align:center;">${statusIcon}</td></tr>`;});const totalEsperado=client.quota*client.term;const saldoPendiente=totalEsperado-totalPagadoReal;scheduleHTML+=`</tbody></table><div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;"><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><strong>Total esperado:</strong><span>S/${formatNumber(totalEsperado)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:8px;"><strong>Total pagado:</strong><span style="color:#28a745;">S/${formatNumber(totalPagadoReal)}</span></div><div style="display:flex;justify-content:space-between;"><strong>Saldo pendiente:</strong><span style="color:#dc3545;">S/${formatNumber(saldoPendiente)}</span></div></div>`;document.getElementById('scheduleModalContent').innerHTML=scheduleHTML;showModal('scheduleModal');}
function showEditClientModal(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;document.getElementById('editClientId').value=client.id;document.getElementById('editClientName').value=client.name;document.getElementById('editClientPhone').value=client.phone||'';document.getElementById('editClientDisbursementDate').value=client.disbursementDate||'';document.getElementById('editClientFrequency').value=client.frequency||'';document.getElementById('editClientQuota').value=client.quota||'';document.getElementById('editClientTerm').value=client.term||'';showModal('editClientModal');}
function updateClient(event){event.preventDefault();const clientId=document.getElementById('editClientId').value;const client=clients.find(c=>c.id===clientId);if(!client)return;client.name=document.getElementById('editClientName').value.trim();client.phone=document.getElementById('editClientPhone').value.trim();client.disbursementDate=document.getElementById('editClientDisbursementDate').value;client.frequency=document.getElementById('editClientFrequency').value;client.quota=parseFloat(document.getElementById('editClientQuota').value);client.term=parseInt(document.getElementById('editClientTerm').value);saveData();updateDisplay();closeModal('editClientModal');alert('Socio actualizado exitosamente');}
function quickPayment(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;const displayQuota=client.diasAtraso>0?client.totalAtraso:client.quota;showAddPaymentModal();document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;selectPaymentType('efectivo');document.getElementById('paymentAmountSingle').value=displayQuota||'';document.getElementById('paymentNote').value='Pago rápido';}
function quickPaymentDebt(clientId){const client=clients.find(c=>c.id===clientId);if(!client)return;showAddPaymentModal();document.getElementById('clientSearchModal').value=client.name;document.getElementById('selectedClientId').value=client.id;selectPaymentType('efectivo');document.getElementById('paymentAmountSingle').value=client.totalAtraso||'';document.getElementById('paymentNote').value='Pago de mora';}
function showMorosidadModal(){const debtClients=clients.filter(c=>c.diasAtraso>0);if(debtClients.length===0){alert('No hay socios en mora actualmente');return;}const totalMora=debtClients.reduce((sum,c)=>sum+(c.mora||0),0);const totalAtraso=debtClients.reduce((sum,c)=>sum+(c.totalAtraso||0),0);let modalHTML=`<div class="morosidad-stats"><div class="morosidad-stat"><div class="morosidad-stat-value">${formatInteger(debtClients.length)}</div><div class="morosidad-stat-label">Socios en Mora</div></div><div class="morosidad-stat"><div class="morosidad-stat-value">S/${formatNumber(totalAtraso)}</div><div class="morosidad-stat-label">Total Atraso</div></div></div><table class="morosidad-table"><thead><tr><th>ID</th><th>Nombre</th><th>Monto</th><th>Plazo</th><th>Frec. Pago</th><th>Mora</th><th>Total Atraso</th><th>Total Deuda</th></tr></thead><tbody>`;debtClients.sort((a,b)=>b.diasAtraso-a.diasAtraso).forEach(client=>{const clientPayments=payments.filter(p=>p.clientId===client.id);const totalPaid=clientPayments.reduce((sum,p)=>sum+p.amount,0);const totalDeuda=(client.monto||0)*(client.term||0)-totalPaid;modalHTML+=`<tr onclick="showClientDetailsModal('${client.id}');closeModal('morosidadModal');" style="cursor:pointer;"><td>${client.id}</td><td>${client.name}</td><td>S/${formatNumber(client.monto||0)}</td><td>${client.term||0}</td><td>${client.frequency||'N/A'}</td><td style="color:#dc3545;">S/${formatNumber(client.mora||0)}</td><td style="color:#dc3545;font-weight:bold;">S/${formatNumber(client.totalAtraso||0)}</td><td style="color:#dc3545;">S/${formatNumber(totalDeuda)}</td></tr>`;});modalHTML+=`</tbody></table>`;document.getElementById('morosidadModalContent').innerHTML=modalHTML;showModal('morosidadModal');}
init();
</script>
</body>
</html>
